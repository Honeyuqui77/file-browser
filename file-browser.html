<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Êú¨Âú∞‰π¶Á±çÊñá‰ª∂ÊµèËßàÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .select-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .select-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .current-path {
            flex: 1;
            padding: 10px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            color: #666;
        }
        
        .content {
            display: flex;
            height: 600px;
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #eee;
            overflow-y: auto;
            padding: 20px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .folder-node {
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .folder-node:hover {
            transform: translateX(5px);
        }
        
        .tag-0 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .tag-1 {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            padding: 10px 15px;
            margin-left: 20px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .tag-2 {
            background: linear-gradient(45deg, #FF6B6B, #EE5A24);
            color: white;
            padding: 8px 15px;
            margin-left: 40px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .tag-3 {
            background: linear-gradient(45deg, #96CEB4, #FFEAA7);
            color: #333;
            padding: 6px 15px;
            margin-left: 60px;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .file-item {
            background: #f8f9fa;
            border: 1px solid #eee;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .file-icon {
            margin-right: 8px;
            color: #667eea;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .breadcrumb {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-family: monospace;
        }
        
        .breadcrumb span {
            color: #667eea;
            cursor: pointer;
        }
        
        .breadcrumb span:hover {
            text-decoration: underline;
        }
        
        .breadcrumb .separator {
            color: #999;
            margin: 0 8px;
        }
        
        .file-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .file-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
            cursor: pointer;
        }
        
        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .batch-actions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .batch-actions.show {
            display: block;
        }
        
        .batch-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        
        .batch-btn:hover {
            background: #c82333;
        }
        
        .batch-btn.success {
            background: #28a745;
        }
        
        .batch-btn.success:hover {
            background: #218838;
        }
        
        .selected-count {
            color: #667eea;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .move-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .move-dialog.show {
            display: flex;
        }
        
        .move-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .move-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .folder-selector {
            margin: 20px 0;
        }
        
        .folder-selector button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .folder-selector button:hover {
            background: #5a6fd8;
        }
        
        .selected-folder {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dialog-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .dialog-btn.confirm {
            background: #28a745;
            color: white;
        }
        
        .dialog-btn:hover {
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Êú¨Âú∞‰π¶Á±çÊñá‰ª∂ÊµèËßàÂô®</h1>
            <p>ÈÄâÊã©‰Ω†ÁöÑ‰π¶Á±çÊñá‰ª∂Â§πÔºåËá™Âä®ÊûÑÂª∫Â±ÇÁ∫ßÁªìÊûÑ</p>
        </div>
        
        <div class="toolbar">
            <button class="select-btn" onclick="selectFolder()">üìÅ ÈÄâÊã©Êñá‰ª∂Â§π</button>
            <div class="current-path" id="currentPath">Êú™ÈÄâÊã©Êñá‰ª∂Â§π</div>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div id="folderTree">
                    <div class="loading">ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂Â§π</div>
                </div>
            </div>
            
            <div class="main-content">
                <div id="stats" class="stats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="folderCount">0</div>
                        <div class="stat-label">Êñá‰ª∂Â§πÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="fileCount">0</div>
                        <div class="stat-label">Êñá‰ª∂Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="levelCount">0</div>
                        <div class="stat-label">Â±ÇÁ∫ßÊ∑±Â∫¶</div>
                    </div>
                </div>
                
                <div id="breadcrumb" class="breadcrumb" style="display: none;"></div>
                
                <div id="currentFolder">
                    <div class="loading">ËØ∑ÈÄâÊã©Êñá‰ª∂Â§πÂºÄÂßãÊµèËßà</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÊâπÈáèÊìç‰ΩúÊ†è -->
    <div id="batchActions" class="batch-actions">
        <span class="selected-count" id="selectedCount">Â∑≤ÈÄâÊã© 0 ‰∏™Êñá‰ª∂</span>
        <button class="batch-btn" onclick="selectAllFiles()">ÂÖ®ÈÄâ</button>
        <button class="batch-btn" onclick="deselectAllFiles()">ÂèñÊ∂àÂÖ®ÈÄâ</button>
        <button class="batch-btn success" onclick="showMoveDialog()">üìÅ ÊâπÈáèËΩ¨Áßª</button>
    </div>
    
    <!-- ËΩ¨ÁßªÂØπËØùÊ°Ü -->
    <div id="moveDialog" class="move-dialog">
        <div class="move-content">
            <h3>üìÅ ÊâπÈáèËΩ¨ÁßªÊñá‰ª∂</h3>
            <p>ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§πÔºåÂ∞ÜÈÄâ‰∏≠ÁöÑÊñá‰ª∂ËΩ¨ÁßªËøáÂéª</p>
            
            <div class="folder-selector">
                <button onclick="selectTargetFolder()">ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π</button>
                <div id="targetFolderPath" class="selected-folder" style="display: none;">
                    Êú™ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="moveStatus"></div>
            
            <div class="dialog-buttons">
                <button class="dialog-btn cancel" onclick="closeMoveDialog()">ÂèñÊ∂à</button>
                <button class="dialog-btn confirm" onclick="executeMove()" id="confirmMoveBtn">Á°ÆËÆ§ËΩ¨Áßª</button>
            </div>
        </div>
    </div>

    <script>
        let currentDirHandle = null;
        let folderStructure = null;
        let currentPath = [];
        let selectedFiles = new Set();
        let targetFolderHandle = null;
        
        // ÈÄâÊã©Êñá‰ª∂Â§π
        async function selectFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                currentDirHandle = dirHandle;
                currentPath = [dirHandle.name];
                
                updateCurrentPath();
                showLoading('Ê≠£Âú®Êâ´ÊèèÊñá‰ª∂Â§πÁªìÊûÑ...');
                
                folderStructure = await scanDirectory(dirHandle, 0);
                displayFolderTree(folderStructure);
                displayCurrentFolder(folderStructure);
                updateStats(folderStructure);
                
                showSuccess('Êñá‰ª∂Â§πÊâ´ÊèèÂÆåÊàêÔºÅ');
                
            } catch (error) {
                console.error('ÈÄâÊã©Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                if (error.name === 'AbortError') {
                    showError('Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂Â§πÈÄâÊã©');
                } else {
                    showError('ÈÄâÊã©Êñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                }
            }
        }
        
        // Êâ´ÊèèÁõÆÂΩïÁªìÊûÑ
        async function scanDirectory(dirHandle, level = 0) {
            const result = {
                id: generateId(),
                name: dirHandle.name,
                path: dirHandle.path || '',
                type: 'folder',
                children: [],
                level: level,
                handle: dirHandle
            };
            
            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory') {
                        const child = await scanDirectory(entry, level + 1);
                        result.children.push(child);
                    } else if (isBookFile(entry.name)) {
                        result.children.push({
                            id: generateId(),
                            name: entry.name,
                            type: 'file',
                            level: level + 1,
                            handle: entry
                        });
                    }
                }
            } catch (error) {
                console.warn('Êâ´ÊèèÊñá‰ª∂Â§πÂ§±Ë¥•:', dirHandle.name, error);
            }
            
            return result;
        }
        
        // Âà§Êñ≠ÊòØÂê¶‰∏∫‰π¶Á±çÊñá‰ª∂ÔºàÁé∞Âú®ÊîØÊåÅÊâÄÊúâÊñá‰ª∂Ôºâ
        function isBookFile(filename) {
            // ÊîØÊåÅÊâÄÊúâÊñá‰ª∂Á±ªÂûã
            return true;
        }
        
        // ÁîüÊàêÂîØ‰∏ÄID
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ÊòæÁ§∫Êñá‰ª∂Â§πÊ†ë
        function displayFolderTree(structure) {
            const treeContainer = document.getElementById('folderTree');
            
            function renderNode(node) {
                const tagType = getTagType(node.level);
                const className = `tag-${Math.min(node.level, 3)}`;
                
                let childrenHtml = '';
                if (node.children && node.children.length > 0) {
                    childrenHtml = node.children.map(child => renderNode(child)).join('');
                }
                
                return `
                    <div class="folder-node ${className}" onclick="selectNode('${node.id}')" data-id="${node.id}">
                        <span class="tag-type">${tagType}</span>
                        <span class="folder-name">${node.name}</span>
                        ${node.children ? `<span class="file-count">(${node.children.length})</span>` : ''}
                    </div>
                    ${childrenHtml}
                `;
            }
            
            treeContainer.innerHTML = renderNode(structure);
        }
        
        // Ëé∑ÂèñÊ†áÁ≠æÁ±ªÂûã
        function getTagType(level) {
            const types = ['Â§ßÊ†áÁ≠æ', '‰∏≠Ê†áÁ≠æ', 'Â∞èÊ†áÁ≠æ', 'ÂæÆÊ†áÁ≠æ'];
            return types[Math.min(level, types.length - 1)];
        }
        
        // ÈÄâÊã©ËäÇÁÇπ
        function selectNode(nodeId) {
            const node = findNodeById(folderStructure, nodeId);
            if (node) {
                displayCurrentFolder(node);
                updateBreadcrumb(node);
            }
        }
        
        // Ê†πÊçÆIDÊü•ÊâæËäÇÁÇπ
        function findNodeById(structure, id) {
            if (structure.id === id) {
                return structure;
            }
            
            if (structure.children) {
                for (const child of structure.children) {
                    const found = findNodeById(child, id);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // ÊòæÁ§∫ÂΩìÂâçÊñá‰ª∂Â§πÂÜÖÂÆπ
        function displayCurrentFolder(node) {
            const container = document.getElementById('currentFolder');
            
            if (!node.children || node.children.length === 0) {
                container.innerHTML = '<div class="loading">Ê≠§Êñá‰ª∂Â§π‰∏∫Á©∫</div>';
                return;
            }
            
            let html = `<h3>üìÅ ${node.name} ÁöÑÂÜÖÂÆπ</h3>`;
            
            // ÂàÜÁ±ªÊòæÁ§∫
            const folders = node.children.filter(item => item.type === 'folder');
            const files = node.children.filter(item => item.type === 'file');
            
            if (folders.length > 0) {
                html += '<h4>üìÇ Â≠êÊñá‰ª∂Â§π</h4>';
                folders.forEach(folder => {
                    html += `
                        <div class="folder-node tag-${Math.min(folder.level, 3)}" onclick="selectNode('${folder.id}')">
                            üìÅ ${folder.name} (${folder.children ? folder.children.length : 0}È°π)
                        </div>
                    `;
                });
            }
            
            if (files.length > 0) {
                html += '<h4>üìÑ Êñá‰ª∂ÂàóË°®</h4>';
                files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <input type="checkbox" class="file-checkbox" id="file_${file.id}" onchange="toggleFileSelection('${file.id}')">
                                <span class="file-icon">üìÑ</span>
                                <span onclick="openFile('${file.id}')" style="cursor: pointer; color: #667eea;">${file.name}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        
        // ÊâìÂºÄÊñá‰ª∂
        async function openFile(fileId) {
            const node = findNodeById(folderStructure, fileId);
            if (node && node.handle) {
                try {
                    const file = await node.handle.getFile();
                    const url = URL.createObjectURL(file);
                    window.open(url, '_blank');
                } catch (error) {
                    showError('Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂: ' + error.message);
                }
            }
        }
        
        // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
        function updateBreadcrumb(node) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.style.display = 'block';
            
            // ÊûÑÂª∫Ë∑ØÂæÑ
            const path = [];
            let current = node;
            while (current) {
                path.unshift(current.name);
                current = current.parent;
            }
            
            let html = '';
            path.forEach((name, index) => {
                if (index > 0) {
                    html += '<span class="separator">></span>';
                }
                html += `<span onclick="navigateToLevel(${index})">${name}</span>`;
            });
            
            breadcrumb.innerHTML = html;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(structure) {
            const stats = document.getElementById('stats');
            stats.style.display = 'grid';
            
            const folderCount = countFolders(structure);
            const fileCount = countFiles(structure);
            const levelCount = getMaxLevel(structure);
            
            document.getElementById('folderCount').textContent = folderCount;
            document.getElementById('fileCount').textContent = fileCount;
            document.getElementById('levelCount').textContent = levelCount;
        }
        
        // ÁªüËÆ°Êñá‰ª∂Â§πÊï∞Èáè
        function countFolders(node) {
            let count = 1; // ÂΩìÂâçËäÇÁÇπ
            if (node.children) {
                node.children.forEach(child => {
                    if (child.type === 'folder') {
                        count += countFolders(child);
                    }
                });
            }
            return count;
        }
        
        // ÁªüËÆ°Êñá‰ª∂Êï∞Èáè
        function countFiles(node) {
            let count = 0;
            if (node.children) {
                node.children.forEach(child => {
                    if (child.type === 'file') {
                        count++;
                    } else {
                        count += countFiles(child);
                    }
                });
            }
            return count;
        }
        
        // Ëé∑ÂèñÊúÄÂ§ßÂ±ÇÁ∫ß
        function getMaxLevel(node) {
            let maxLevel = node.level;
            if (node.children) {
                node.children.forEach(child => {
                    maxLevel = Math.max(maxLevel, getMaxLevel(child));
                });
            }
            return maxLevel + 1;
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑÊòæÁ§∫
        function updateCurrentPath() {
            const pathElement = document.getElementById('currentPath');
            pathElement.textContent = currentPath.join(' > ');
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        function showLoading(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="loading">${message}</div>`;
        }
        
        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccess(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="success">${message}</div>`;
        }
        
        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showError(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // ÂàáÊç¢Êñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅ
        function toggleFileSelection(fileId) {
            if (selectedFiles.has(fileId)) {
                selectedFiles.delete(fileId);
            } else {
                selectedFiles.add(fileId);
            }
            updateBatchActions();
            console.log('ÂΩìÂâçÈÄâÊã©ÁöÑÊñá‰ª∂:', Array.from(selectedFiles));
        }
        
        // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊ†è
        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            console.log('Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊ†èÔºåÈÄâÊã©ÁöÑÊñá‰ª∂Êï∞Èáè:', selectedFiles.size);
            
            if (selectedFiles.size > 0) {
                batchActions.classList.add('show');
                selectedCount.textContent = `Â∑≤ÈÄâÊã© ${selectedFiles.size} ‰∏™Êñá‰ª∂`;
                console.log('ÊòæÁ§∫ÊâπÈáèÊìç‰ΩúÊ†è');
            } else {
                batchActions.classList.remove('show');
                console.log('ÈöêËóèÊâπÈáèÊìç‰ΩúÊ†è');
            }
        }
        
        // ÂÖ®ÈÄâÊñá‰ª∂
        function selectAllFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const fileId = checkbox.id.replace('file_', '');
                selectedFiles.add(fileId);
            });
            updateBatchActions();
        }
        
        // ÂèñÊ∂àÂÖ®ÈÄâ
        function deselectAllFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedFiles.clear();
            updateBatchActions();
        }
        
        // ÊòæÁ§∫ËΩ¨ÁßªÂØπËØùÊ°Ü
        function showMoveDialog() {
            if (selectedFiles.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅËΩ¨ÁßªÁöÑÊñá‰ª∂');
                return;
            }
            
            document.getElementById('moveDialog').classList.add('show');
            targetFolderHandle = null;
            document.getElementById('targetFolderPath').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('moveStatus').innerHTML = '';
        }
        
        // ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π
        async function selectTargetFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                targetFolderHandle = dirHandle;
                document.getElementById('targetFolderPath').textContent = dirHandle.name;
                document.getElementById('targetFolderPath').style.display = 'block';
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                }
            }
        }
        
        // ÂÖ≥Èó≠ËΩ¨ÁßªÂØπËØùÊ°Ü
        function closeMoveDialog() {
            document.getElementById('moveDialog').classList.remove('show');
            targetFolderHandle = null;
        }
        
        // ÊâßË°åÊñá‰ª∂ËΩ¨Áßª
        async function executeMove() {
            if (!targetFolderHandle) {
                alert('ËØ∑ÂÖàÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmMoveBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const moveStatus = document.getElementById('moveStatus');
            
            confirmBtn.disabled = true;
            progressBar.style.display = 'block';
            moveStatus.innerHTML = '<p>Ê≠£Âú®ËΩ¨ÁßªÊñá‰ª∂...</p>';
            
            let successCount = 0;
            let failCount = 0;
            const totalFiles = selectedFiles.size;
            let currentIndex = 0;
            
            for (const fileId of selectedFiles) {
                try {
                    const fileNode = findNodeById(folderStructure, fileId);
                    if (fileNode && fileNode.handle) {
                        // Ëé∑ÂèñÊ∫êÊñá‰ª∂
                        const sourceFile = await fileNode.handle.getFile();
                        
                        // Ê£ÄÊü•ÁõÆÊ†áÊñá‰ª∂Â§π‰∏≠ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÊñá‰ª∂
                        let targetFileName = fileNode.name;
                        let counter = 1;
                        
                        while (true) {
                            try {
                                await targetFolderHandle.getFileHandle(targetFileName);
                                // Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåÈáçÂëΩÂêç
                                const nameParts = fileNode.name.split('.');
                                const ext = nameParts.pop();
                                const baseName = nameParts.join('.');
                                targetFileName = `${baseName}_${counter}.${ext}`;
                                counter++;
                            } catch {
                                // Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™ÂêçÁß∞
                                break;
                            }
                        }
                        
                        // ÂàõÂª∫Êñ∞Êñá‰ª∂
                        const targetFileHandle = await targetFolderHandle.getFileHandle(targetFileName, { create: true });
                        const writable = await targetFileHandle.createWritable();
                        
                        // ÂÜôÂÖ•Êñá‰ª∂ÂÜÖÂÆπ
                        await writable.write(sourceFile);
                        await writable.close();
                        
                        // Âà†Èô§ÂéüÊñá‰ª∂
                        await fileNode.handle.remove();
                        
                        successCount++;
                    }
                } catch (error) {
                    console.error('ËΩ¨ÁßªÊñá‰ª∂Â§±Ë¥•:', error);
                    failCount++;
                }
                
                currentIndex++;
                const progress = (currentIndex / totalFiles) * 100;
                progressFill.style.width = progress + '%';
                
                moveStatus.innerHTML = `
                    <p>Ê≠£Âú®ËΩ¨ÁßªÊñá‰ª∂... (${currentIndex}/${totalFiles})</p>
                    <p>ÊàêÂäü: ${successCount}, Â§±Ë¥•: ${failCount}</p>
                `;
            }
            
            // ËΩ¨ÁßªÂÆåÊàê
            moveStatus.innerHTML = `
                <div class="success">
                    <p>ËΩ¨ÁßªÂÆåÊàêÔºÅ</p>
                    <p>ÊàêÂäü: ${successCount} ‰∏™Êñá‰ª∂</p>
                    <p>Â§±Ë¥•: ${failCount} ‰∏™Êñá‰ª∂</p>
                </div>
            `;
            
            // ÈáçÊñ∞Êâ´ÊèèÊñá‰ª∂Â§πÁªìÊûÑ
            if (currentDirHandle) {
                folderStructure = await scanDirectory(currentDirHandle, 0);
                displayFolderTree(folderStructure);
                displayCurrentFolder(folderStructure);
                updateStats(folderStructure);
            }
            
            // Ê∏ÖÁ©∫ÈÄâÊã©
            selectedFiles.clear();
            updateBatchActions();
            
            // 3ÁßíÂêéÂÖ≥Èó≠ÂØπËØùÊ°Ü
            setTimeout(() => {
                closeMoveDialog();
            }, 3000);
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàê
        window.onload = function() {
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
            if (!('showDirectoryPicker' in window)) {
                showError('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊñá‰ª∂Á≥ªÁªüËÆøÈóÆAPIÔºåËØ∑‰ΩøÁî®Chrome„ÄÅEdgeÊàñFirefoxÊúÄÊñ∞ÁâàÊú¨');
            }
        };
    </script>
</body>
</html> 