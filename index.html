<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö ÈÜíÈÜíÁöÑ‰∏ìÂ±û‰π¶Á±çÊñá‰ª∂ÁÆ°ÁêÜÂô®</title>
    <!-- Ê∑ªÂä†SheetJSÂ∫ìÁî®‰∫éExcelÂØºÂá∫ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .toolbar {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .select-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: none;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
        }

        .path-btn {
            background: linear-gradient(135deg, #fd7e14 0%, #e63946 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
            margin-left: 10px;
        }

        .path-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(253, 126, 20, 0.4);
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            pointer-events: none;
        }
        
        .current-path {
            flex: 1;
            padding: 10px 15px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: monospace;
            color: #495057;
            min-width: 200px;
        }
        
        .content {
            display: flex;
            height: 600px;
        }
        
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            padding: 20px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .folder-node {
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .folder-node:hover {
            transform: translateX(5px);
        }
        
        .tag-0 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .tag-1 {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 10px 15px;
            margin-left: 20px;
            margin-bottom: 8px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(78, 205, 196, 0.3);
        }
        
        .tag-2 {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A24 100%);
            color: white;
            padding: 8px 15px;
            margin-left: 40px;
            margin-bottom: 6px;
            font-size: 13px;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }
        
        .tag-3 {
            background: linear-gradient(135deg, #96CEB4 0%, #FFEAA7 100%);
            color: #2d3436;
            padding: 6px 15px;
            margin-left: 60px;
            margin-bottom: 4px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(150, 206, 180, 0.3);
        }
        
        .file-item {
            background: white;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            margin: 6px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .file-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }
        
        .file-icon {
            margin-right: 8px;
            color: #667eea;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .breadcrumb {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: monospace;
            border: 1px solid #dee2e6;
        }
        
        .breadcrumb span {
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .breadcrumb span:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .breadcrumb .separator {
            color: #6c757d;
            margin: 0 8px;
        }
        
        .file-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }
        
        .file-item.selected {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196f3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .file-item.selecting {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #ff9800;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.2);
        }
        
        .file-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .file-info:hover {
            color: #667eea;
        }
        
        .batch-actions {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .batch-actions.show {
            display: block;
        }
        
        .batch-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
        }
        
        .batch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .batch-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
        }
        
        .batch-btn.success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .selected-count {
            color: #667eea;
            font-weight: bold;
            margin-right: 15px;
            font-size: 16px;
        }
        
        /* Â∏ÆÂä©ÊåâÈíÆÊ†∑Âºè */
        .help-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .help-btn:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }
        
        /* ÊäÄÊúØÊîØÊåÅËÅîÁ≥ªÊñπÂºè */
        .support-info {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: #667eea;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .support-info:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transform: translateX(-50%) scale(1.05);
        }
        
        /* Áà±ÂøÉÂä®ÁîªÊ†∑Âºè */
        .heart {
            position: fixed;
            font-size: 24px;
            color: #ff6b6b;
            pointer-events: none;
            z-index: 2000;
            animation: heartFloat 3s ease-out forwards;
        }
        
        @keyframes heartFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            30% {
                opacity: 0.9;
                transform: translateY(-30px) scale(1.1);
            }
            60% {
                opacity: 0.7;
                transform: translateY(-60px) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.6);
            }
        }
        
        /* Â∏ÆÂä©ÂØπËØùÊ°ÜÊ†∑Âºè */
        .help-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .help-dialog.show {
            display: flex;
        }
        
        .help-content {
            background: white;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .help-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .help-header h2 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .help-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .help-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .help-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .help-section h4 {
            color: #495057;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
        }
        
        .help-section p {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .help-section ul, .help-section ol {
            color: #495057;
            line-height: 1.8;
            padding-left: 20px;
        }
        
        .help-section li {
            margin-bottom: 8px;
        }
        
        .help-section strong {
            color: #667eea;
        }
        
        .move-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .move-dialog.show {
            display: flex;
        }
        
        .move-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .move-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .folder-selector {
            margin: 20px 0;
        }
        
        .folder-selector button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .folder-selector button:hover {
            background: #5a6fd8;
        }
        
        .selected-folder {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .dialog-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dialog-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .dialog-btn.confirm {
            background: #28a745;
            color: white;
        }
        
        .dialog-btn:hover {
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö ÈÜíÈÜíÁöÑ‰∏ìÂ±û‰π¶Á±çÊñá‰ª∂ÁÆ°ÁêÜÂô®</h1>
            <p>ÈÄâÊã©‰Ω†ÁöÑ‰π¶Á±çÊñá‰ª∂Â§πÔºåËá™Âä®ÊûÑÂª∫Â±ÇÁ∫ßÁªìÊûÑ</p>
        </div>
        
        <div class="toolbar">
            <button class="select-btn" onclick="selectFolder()">üìÅ ÈÄâÊã©Êñá‰ª∂Â§π</button>
            <button class="export-btn" onclick="exportToExcel()" id="exportBtn" style="display: none;">üìä ÂØºÂá∫Excel</button>
            <div class="search-box">
                <input type="text" class="search-input" placeholder="ÊêúÁ¥¢Êñá‰ª∂ÊàñÊñá‰ª∂Â§π...">
                <span class="search-icon">üîç</span>
            </div>
            <div class="current-path" id="currentPath">Êú™ÈÄâÊã©Êñá‰ª∂Â§π</div>
            <button class="back-btn" onclick="goBack()">‚¨ÖÔ∏è ËøîÂõû</button>
            <button class="path-btn" onclick="setBasePath()" title="ËÆæÁΩÆÂÆåÊï¥Ë∑ØÂæÑ">üìç ËÆæÁΩÆË∑ØÂæÑ</button>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div id="folderTree">
                    <div class="loading">ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂Â§π</div>
                </div>
            </div>
            
            <div class="main-content">
                <div id="stats" class="stats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-number" id="folderCount">0</div>
                        <div class="stat-label">Êñá‰ª∂Â§πÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="fileCount">0</div>
                        <div class="stat-label">Êñá‰ª∂Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="levelCount">0</div>
                        <div class="stat-label">Â±ÇÁ∫ßÊ∑±Â∫¶</div>
                    </div>
                </div>
                
                <div id="breadcrumb" class="breadcrumb" style="display: none;"></div>
                
                <div id="currentFolder">
                    <div class="loading">ËØ∑ÈÄâÊã©Êñá‰ª∂Â§πÂºÄÂßãÊµèËßà</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÊâπÈáèÊìç‰ΩúÊ†è -->
    <div id="batchActions" class="batch-actions">
        <span class="selected-count" id="selectedCount">Â∑≤ÈÄâÊã© 0 ‰∏™Êñá‰ª∂</span>
        <button class="batch-btn" onclick="selectAllFiles()">ÂÖ®ÈÄâ</button>
        <button class="batch-btn" onclick="deselectAllFiles()">ÂèñÊ∂àÂÖ®ÈÄâ</button>
        <button class="batch-btn success" onclick="showMoveDialog()">üìÅ ÊâπÈáèËΩ¨Áßª</button>
    </div>
    
    <!-- ËΩ¨ÁßªÂØπËØùÊ°Ü -->
    <div id="moveDialog" class="move-dialog">
        <div class="move-content">
            <h3>üìÅ ÊâπÈáèËΩ¨ÁßªÊñá‰ª∂</h3>
            <p>ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§πÔºåÂ∞ÜÈÄâ‰∏≠ÁöÑÊñá‰ª∂ËΩ¨ÁßªËøáÂéª</p>
            
            <div class="folder-selector">
                <button onclick="selectTargetFolder()">ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π</button>
                <div id="targetFolderPath" class="selected-folder" style="display: none;">
                    Êú™ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π
                </div>
            </div>
            
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="moveStatus"></div>
            
            <div class="dialog-buttons">
                <button class="dialog-btn cancel" onclick="closeMoveDialog()">ÂèñÊ∂à</button>
                <button class="dialog-btn confirm" onclick="executeMove()" id="confirmMoveBtn">Á°ÆËÆ§ËΩ¨Áßª</button>
            </div>
        </div>
    </div>

    <!-- Â∏ÆÂä©ÊåâÈíÆ -->
    <div class="help-btn" onclick="toggleHelp()">‚ùì Â∏ÆÂä©</div>
    
    <!-- ÊäÄÊúØÊîØÊåÅËÅîÁ≥ªÊñπÂºè -->
    <div class="support-info" onclick="showHeart()">
        ÊäÄÊúØÊîØÊåÅËØ∑ËÅîÁ≥ªÔºö<br>
        <strong>shenyicheng3</strong>
    </div>
    
    <!-- Â∏ÆÂä©ÊñáÊ°£ -->
    <div id="helpDialog" class="help-dialog">
        <div class="help-content">
            <div class="help-header">
                <h2>üìö ÈÜíÈÜí‰∏ìÂ±û‰π¶Á±çÊñá‰ª∂ÁÆ°ÁêÜÂô® - ‰ΩøÁî®ËØ¥Êòé</h2>
                <button class="close-btn" onclick="toggleHelp()">‚úï</button>
            </div>
            
            <div class="help-body">
                <div class="help-section">
                    <h3>üöÄ Âø´ÈÄüÂºÄÂßã</h3>
                    <ol>
                        <li><strong>ÈÄâÊã©Êñá‰ª∂Â§π</strong>ÔºöÁÇπÂáªÂ∑¶‰∏äËßíÁöÑ"üìÅ ÈÄâÊã©Êñá‰ª∂Â§π"ÊåâÈíÆ</li>
                        <li><strong>Á≠âÂæÖÊâ´Êèè</strong>ÔºöÁ≥ªÁªü‰ºöËá™Âä®Êâ´ÊèèÂπ∂ÊûÑÂª∫Êñá‰ª∂Â§πÂ±ÇÁ∫ßÁªìÊûÑ</li>
                        <li><strong>ÂºÄÂßãÊµèËßà</strong>ÔºöÂú®Â∑¶‰æßÂèØ‰ª•ÁúãÂà∞Êñá‰ª∂Â§πÊ†ëÔºåÂè≥‰æßÊòæÁ§∫ÂΩìÂâçÊñá‰ª∂Â§πÂÜÖÂÆπ</li>
                    </ol>
                </div>
                
                <div class="help-section">
                    <h3>üîç ÊêúÁ¥¢ÂäüËÉΩ</h3>
                    <ul>
                        <li><strong>ÂÆûÊó∂ÊêúÁ¥¢</strong>ÔºöÂú®ÊêúÁ¥¢Ê°Ü‰∏≠ËæìÂÖ•ÂÖ≥ÈîÆËØçÔºåÊîØÊåÅÊñá‰ª∂ÂêçÂíåÊñá‰ª∂Â§πÂêçÊêúÁ¥¢</li>
                        <li><strong>ÂÖ®Â±ÄÊêúÁ¥¢</strong>ÔºöÊêúÁ¥¢ËåÉÂõ¥Ë¶ÜÁõñÊï¥‰∏™ÈÄâÊã©ÁöÑÁ£ÅÁõò</li>
                        <li><strong>Âø´ÈÄüË∑≥ËΩ¨</strong>ÔºöÁÇπÂáªÊêúÁ¥¢ÁªìÊûúÂèØÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂØπÂ∫î‰ΩçÁΩÆ</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üìÅ ÂØºËà™ÂäüËÉΩ</h3>
                    <ul>
                        <li><strong>Êñá‰ª∂Â§πÊ†ë</strong>ÔºöÂ∑¶‰æßÊòæÁ§∫Â±ÇÁ∫ßÁªìÊûÑÔºåÁÇπÂáªÂèØËøõÂÖ•ÂØπÂ∫îÊñá‰ª∂Â§π</li>
                        <li><strong>Èù¢ÂåÖÂ±ëÂØºËà™</strong>ÔºöÈ°∂ÈÉ®ÊòæÁ§∫ÂΩìÂâçË∑ØÂæÑÔºåÁÇπÂáª‰ªªÊÑèÈÉ®ÂàÜÂèØÂø´ÈÄüË∑≥ËΩ¨</li>
                        <li><strong>ËøîÂõûÊåâÈíÆ</strong>Ôºö‰ΩøÁî®"‚¨ÖÔ∏è ËøîÂõû"ÊåâÈíÆËøîÂõû‰∏äÁ∫ßÁõÆÂΩï</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>‚úÖ Êñá‰ª∂ÈÄâÊã©</h3>
                    <h4>Âçï‰∏™ÈÄâÊã©</h4>
                    <ul>
                        <li>Áõ¥Êé•ÁÇπÂáªÊñá‰ª∂ÂâçÁöÑÂ§çÈÄâÊ°Ü</li>
                        <li>ÁÇπÂáªÊñá‰ª∂Ë°å‰πüÂèØ‰ª•ÈÄâÊã©/ÂèñÊ∂àÈÄâÊã©</li>
                    </ul>
                    
                    <h4>ÊâπÈáèÈÄâÊã©</h4>
                    <ul>
                        <li><strong>Shift + ÁÇπÂáª</strong>ÔºöÈÄâÊã©‰∏§‰∏™Êñá‰ª∂‰πãÈó¥ÁöÑÊâÄÊúâÊñá‰ª∂</li>
                        <li><strong>ÊãñÊãΩÈÄâÊã©</strong>ÔºöÊåâ‰ΩèÈº†Ê†áÂ∑¶ÈîÆÊãñÊãΩÈÄâÊã©ËåÉÂõ¥</li>
                        <li><strong>Ëá™Âä®ÊªöÂä®</strong>ÔºöÊãñÊãΩÂà∞Â∫ïÈÉ®/È°∂ÈÉ®Êó∂Ëá™Âä®ÊªöÂä®Âπ∂ÈÄâÊã©Êõ¥Â§öÊñá‰ª∂</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üîÑ ÊâπÈáèÊìç‰Ωú</h3>
                    <p>ÈÄâÊã©Êñá‰ª∂ÂêéÔºåÂ∫ïÈÉ®‰ºöÊòæÁ§∫ÊâπÈáèÊìç‰ΩúÊ†èÔºö</p>
                    <ul>
                        <li><strong>ÂÖ®ÈÄâ</strong>ÔºöÈÄâÊã©ÂΩìÂâçÊñá‰ª∂Â§π‰∏≠ÁöÑÊâÄÊúâÊñá‰ª∂</li>
                        <li><strong>ÂèñÊ∂àÂÖ®ÈÄâ</strong>ÔºöÂèñÊ∂àÊâÄÊúâÈÄâÊã©</li>
                        <li><strong>ÊâπÈáèËΩ¨Áßª</strong>ÔºöÂ∞ÜÈÄâ‰∏≠ÁöÑÊñá‰ª∂ÁßªÂä®Âà∞ÂÖ∂‰ªñÊñá‰ª∂Â§π</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üìä ExcelÂØºÂá∫ÂäüËÉΩ</h3>
                    <p>ÁÇπÂáª"üìä ÂØºÂá∫Excel"ÊåâÈíÆÔºåÁ≥ªÁªü‰ºöËá™Âä®ËØÜÂà´Êñá‰ª∂ÂêçÂπ∂ÁîüÊàêExcelË°®Ê†ºÔºö</p>
                    
                    <h4>ÂØºÂá∫ÂÜÖÂÆπ</h4>
                    <ul>
                        <li><strong>Êñá‰ª∂Âêç</strong>ÔºöÂéüÂßãÊñá‰ª∂Âêç</li>
                        <li><strong>‰π¶Âêç</strong>ÔºöËá™Âä®ÊèêÂèñÂπ∂Ê∑ªÂä†„Ää„ÄãÁ¨¶Âè∑</li>
                        <li><strong>Ê†áÁ≠æ</strong>ÔºöËá™Âä®ËØÜÂà´ÂõõÁßçÊã¨Âè∑‰∏≠ÁöÑÂÜÖÂÆπ</li>
                        <li><strong>‰ΩúËÄÖ</strong>ÔºöËá™Âä®ËØÜÂà´Â§öÁßçÊ†ºÂºèÁöÑ‰ΩúËÄÖ‰ø°ÊÅØ</li>
                        <li><strong>Êñá‰ª∂Ë∑ØÂæÑ</strong>ÔºöËÆ∞ÂΩïÊñá‰ª∂ÊâÄÂú®ÁöÑÂÆåÊï¥Ë∑ØÂæÑÔºàÂèØÊâãÂä®ËÆæÁΩÆÔºâ</li>
                    </ul>
                    
                    <h4>Ë∑ØÂæÑËÆæÁΩÆËØ¥Êòé</h4>
                    <p>ÁÇπÂáª"üìç ËÆæÁΩÆË∑ØÂæÑ"ÊåâÈíÆÂèØ‰ª•ÊâãÂä®ËÆæÁΩÆÊñá‰ª∂Â§πÁöÑÂÆåÊï¥Ë∑ØÂæÑÔºåËøôÊ†∑ÂØºÂá∫ÁöÑExcel‰∏≠Â∞±‰ºöÊòæÁ§∫ÂÆåÊï¥ÁöÑÊñá‰ª∂Á≥ªÁªüË∑ØÂæÑËÄå‰∏çÊòØÁõ∏ÂØπË∑ØÂæÑ„ÄÇ</p>
                    
                    <h4>Êô∫ËÉΩËØÜÂà´ËßÑÂàô</h4>
                    <ul>
                        <li><strong>‰π¶Âêç</strong>ÔºöËá™Âä®ÊèêÂèñÂπ∂Ê∑ªÂä†„Ää„ÄãÁ¨¶Âè∑</li>
                        <li><strong>Ê†áÁ≠æ</strong>ÔºöËá™Âä®ËØÜÂà´ÂõõÁßçÊã¨Âè∑‰∏≠ÁöÑÂÜÖÂÆπ</li>
                        <li><strong>‰ΩúËÄÖ</strong>ÔºöËá™Âä®ËØÜÂà´Â§öÁßçÊ†ºÂºèÁöÑ‰ΩúËÄÖ‰ø°ÊÅØ</li>
                    </ul>
                    
                    <h4>ÊîØÊåÅÁöÑÊ†áÁ≠æÊ†ºÂºè</h4>
                    <ul>
                        <li><strong>‰∏≠ÊñáÊã¨Âè∑</strong>ÔºöÔºàÊ†°Âõ≠ Âà´Êâ≠ÂèóÔºâ</li>
                        <li><strong>Ëã±ÊñáÊã¨Âè∑</strong>Ôºö(Ê¨ßÈ£é ËÖπÈªëÊ∏©ÊüîÊîª)</li>
                        <li><strong>ÊñπÊã¨Âè∑</strong>Ôºö[Âè§‰ª£-NP]</li>
                        <li><strong>‰∏≠ÊñáÊñπÊã¨Âè∑</strong>Ôºö„ÄêÊ†°Âõ≠Êñá„Äë</li>
                    </ul>
                    
                    <h4>ËØÜÂà´Á§∫‰æã</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>Á§∫‰æã1Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºö'Âèó'‰∏∫‰∏ä„ÄÅÁÆú‰πã‰º∂ÔºàÊ†°Âõ≠ Âà´Êâ≠ÂèóÔºâ.txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„Ää'Âèó'‰∏∫‰∏ä„ÄÅÁÆú‰πã‰º∂„Äã Ê†áÁ≠æÔºöÊ†°Âõ≠ Âà´Êâ≠Âèó ‰ΩúËÄÖÔºöÊöÇÊó†‰ΩúËÄÖ</p>
                        
                        <p><strong>Á§∫‰æã2Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºö[Âè§‰ª£-NP]„Ää‰∏∫Áöá„Äã‰ΩúËÄÖÔºöcallmeÂèóÔºàNPÊÄªÊîªÔºâ.txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„Ää‰∏∫Áöá„Äã Ê†áÁ≠æÔºöÂè§‰ª£-NP NPÊÄªÊîª ‰ΩúËÄÖÔºöcallmeÂèó</p>
                        
                        <p><strong>Á§∫‰æã3Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºö„Ää‰∏çÊúΩ„ÄãBY Sophia (Ê¨ßÈ£é ËÖπÈªëÊ∏©ÊüîÊîªXÊ≠£Áõ¥ÂÇ≤Â®áÂèó).txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„Ää‰∏çÊúΩ„Äã Ê†áÁ≠æÔºöÊ¨ßÈ£é ËÖπÈªëÊ∏©ÊüîÊîªXÊ≠£Áõ¥ÂÇ≤Â®áÂèó ‰ΩúËÄÖÔºöSophia</p>
                        
                        <p><strong>Á§∫‰æã4Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºö„Ää‰π¶Âêç„Äã‰ΩúËÄÖ‰∏Ä‰∏™Ëå∂Â£∂„ÄêÊ†°Âõ≠„Äë.txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„Ää‰π¶Âêç„Äã Ê†áÁ≠æÔºöÊ†°Âõ≠ ‰ΩúËÄÖÔºö‰∏Ä‰∏™Ëå∂Â£∂</p>
                        
                        <p><strong>Á§∫‰æã5Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºö„ÄäÂè¶‰∏ÄÊú¨‰π¶„Äãby‰∏Ä‰∏™ÂÖÖÁîµÂô®ÔºàÁé∞‰ª£Ôºâ.txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„ÄäÂè¶‰∏ÄÊú¨‰π¶„Äã Ê†áÁ≠æÔºöÁé∞‰ª£ ‰ΩúËÄÖÔºö‰∏Ä‰∏™ÂÖÖÁîµÂô®</p>
                        
                        <p><strong>Á§∫‰æã6Ôºö</strong></p>
                        <p>Êñá‰ª∂ÂêçÔºöÁÆÄÂçïÊñá‰ª∂Âêç.txt</p>
                        <p>ËØÜÂà´ÁªìÊûúÔºö‰π¶Âêç„ÄäÁÆÄÂçïÊñá‰ª∂Âêç„Äã Ê†áÁ≠æÔºöÊöÇÊó†Ê†áÁ≠æ ‰ΩúËÄÖÔºöÊöÇÊó†‰ΩúËÄÖ</p>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üí° ‰ΩøÁî®ÊäÄÂ∑ß</h3>
                    <ul>
                        <li><strong>Âø´ÈÄüÂÆö‰Ωç</strong>Ôºö‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÂø´ÈÄüÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂</li>
                        <li><strong>ÊâπÈáèÊï¥ÁêÜ</strong>ÔºöÈÄâÊã©Â§ö‰∏™Êñá‰ª∂Âêé‰ΩøÁî®ÊâπÈáèËΩ¨ÁßªÂäüËÉΩÊï¥ÁêÜÊñá‰ª∂</li>
                        <li><strong>Êô∫ËÉΩÂØºÂá∫</strong>Ôºö‰ΩøÁî®ExcelÂØºÂá∫ÂäüËÉΩÔºåËá™Âä®Êï¥ÁêÜ‰π¶Á±ç‰ø°ÊÅØ</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π</h3>
                    <ul>
                        <li>Êú¨Â∑•ÂÖ∑‰ΩøÁî®ÊµèËßàÂô®Êñá‰ª∂Á≥ªÁªüAPIÔºåÈúÄË¶ÅÁé∞‰ª£ÊµèËßàÂô®ÊîØÊåÅ</li>
                        <li>Âª∫ËÆÆ‰ΩøÁî®Chrome„ÄÅEdgeÊàñFirefoxÊúÄÊñ∞ÁâàÊú¨</li>
                        <li>Êñá‰ª∂Êìç‰Ωú‰ºöÁõ¥Êé•‰øÆÊîπÊú¨Âú∞Êñá‰ª∂ÔºåËØ∑Ë∞®ÊÖéÊìç‰Ωú</li>
                        <li>ÊâπÈáèËΩ¨ÁßªÂâçËØ∑Á°ÆËÆ§ÁõÆÊ†áÊñá‰ª∂Â§π‰ΩçÁΩÆÊ≠£Á°Æ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDirHandle = null;
        let folderStructure = null;
        let currentPath = [];
        let selectedFiles = new Set();
        let targetFolderHandle = null;
        let navigationHistory = [];
        let currentHistoryIndex = -1;
        let fullBasePath = ''; // Â≠òÂÇ®ÂÆåÊï¥ÁöÑÂü∫Á°ÄË∑ØÂæÑ
        let lastSelectedFile = null;
        let isShiftPressed = false;
        
        // ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Shift') {
                isShiftPressed = true;
            }
        });
        
        document.addEventListener('keyup', function(e) {
            if (e.key === 'Shift') {
                isShiftPressed = false;
            }
        });
        
        // ÊêúÁ¥¢ÂäüËÉΩ
        document.querySelector('.search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length > 0) {
                searchFiles(searchTerm);
            } else {
                // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊòæÁ§∫ÂΩìÂâçÊñá‰ª∂Â§πÂÜÖÂÆπ
                if (navigationHistory.length > 0) {
                    const currentNode = navigationHistory[currentHistoryIndex];
                    if (currentNode) {
                        displayCurrentFolder(currentNode);
                    }
                }
            }
        });
        
        // ÊêúÁ¥¢Êñá‰ª∂ - ÊîØÊåÅÊï¥‰∏™Á£ÅÁõòÊêúÁ¥¢
        function searchFiles(searchTerm) {
            if (!folderStructure) return;
            
            const results = [];
            searchInNode(folderStructure, searchTerm, results);
            
            const container = document.getElementById('currentFolder');
            if (results.length === 0) {
                container.innerHTML = `<div class="loading">Êú™ÊâæÂà∞ÂåÖÂê´ "${searchTerm}" ÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π</div>`;
                return;
            }
            
            let html = `<h3>üîç ÊêúÁ¥¢ÁªìÊûú: "${searchTerm}" (${results.length}È°π)</h3>`;
            
            results.forEach(item => {
                const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
                const path = getItemPath(item);
                html += `
                    <div class="file-item" onclick="navigateToItem('${item.id}')">
                        <div class="file-info">
                            <span class="file-icon">${icon}</span>
                            <span>${item.name}</span>
                            <small style="color: #666; margin-left: 10px;">${path}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Âú®ËäÇÁÇπ‰∏≠ÊêúÁ¥¢ - ÈÄíÂΩíÊêúÁ¥¢Êï¥‰∏™Á£ÅÁõò
        function searchInNode(node, searchTerm, results) {
            if (node.name.toLowerCase().includes(searchTerm)) {
                results.push(node);
            }
            
            if (node.children) {
                node.children.forEach(child => {
                    searchInNode(child, searchTerm, results);
                });
            }
        }
        
        // Ëé∑ÂèñÈ°πÁõÆÂÆåÊï¥Ë∑ØÂæÑ
        function getItemPath(item) {
            const path = [];
            let current = item;
            
            // ‰ªéÂΩìÂâçÈ°πÁõÆÂºÄÂßãÔºåÂêë‰∏äÊûÑÂª∫Ë∑ØÂæÑÁõ¥Âà∞Ê†πÁõÆÂΩï
            while (current && current.name) {
                path.unshift(current.name);
                current = current.parent;
            }
            
            // ‰ΩøÁî®Â≠òÂÇ®ÁöÑÂÆåÊï¥Âü∫Á°ÄË∑ØÂæÑÊõø‰ª£Ê†πÁõÆÂΩïÂêç
            if (path.length > 0 && fullBasePath) {
                // ÁßªÈô§Á¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÊ†πÁõÆÂΩïÂêçÔºâÔºåÁî®ÂÆåÊï¥Ë∑ØÂæÑÊõø‰ª£
                path[0] = fullBasePath;
                return path.join('\\');
            } else if (path.length > 0 && currentDirHandle && currentDirHandle.name) {
                // Â¶ÇÊûúÊ≤°ÊúâÂÆåÊï¥Ë∑ØÂæÑÔºå‰ΩøÁî®Êñá‰ª∂Â§πÂêç
                path[0] = `[${currentDirHandle.name}]`;
                return path.join(' > ');
            }
            
            return path.join(' > ');
        }
        
        // ËøîÂõû‰∏ä‰∏ÄÁ∫ß
        function goBack() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                const previousNode = navigationHistory[currentHistoryIndex];
                if (previousNode) {
                    displayCurrentFolder(previousNode);
                    updateBreadcrumb(previousNode);
                    updateBackButton();
                }
            }
        }
        
        // Êõ¥Êñ∞ËøîÂõûÊåâÈíÆÁä∂ÊÄÅ
        function updateBackButton() {
            const backBtn = document.querySelector('.back-btn');
            if (currentHistoryIndex > 0) {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }
        }
        
        // ÂØºËà™Âà∞ÊåáÂÆöÈ°πÁõÆ
        function navigateToItem(itemId) {
            const item = findNodeById(folderStructure, itemId);
            if (item) {
                if (item.type === 'folder') {
                    // ÊûÑÂª∫Âà∞ÁõÆÊ†áÊñá‰ª∂Â§πÁöÑÂÆåÊï¥Ë∑ØÂæÑ
                    const pathToTarget = [];
                    let current = item;
                    while (current && current.name) {
                        pathToTarget.unshift(current);
                        current = current.parent;
                    }
                    
                    // Ê∏ÖÁ©∫ÂΩìÂâçÂéÜÂè≤ÔºåÈáçÊñ∞ÊûÑÂª∫
                    navigationHistory = [];
                    currentHistoryIndex = -1;
                    
                    // ÈÄêÁ∫ßÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    pathToTarget.forEach((pathNode, index) => {
                        navigationHistory.push(pathNode);
                        currentHistoryIndex = index;
                    });
                    
                    displayCurrentFolder(item);
                    updateBreadcrumb(item);
                    updateBackButton();
                } else {
                    openFile(itemId);
                }
            }
        }
        
        // Êô∫ËÉΩË∑ØÂæÑÈ¢ÑÊµãÁ≥ªÁªü
        async function getFullPath(dirHandle) {
            try {
                const folderName = dirHandle.name;
                
                // ÊñπÊ≥ï1: Âü∫‰∫éÂéÜÂè≤Ê®°ÂºèÁöÑÊô∫ËÉΩÈ¢ÑÊµã
                const predictedPath = predictPathFromHistory(folderName);
                if (predictedPath) {
                    console.log('Âü∫‰∫éÂéÜÂè≤Ê®°ÂºèÈ¢ÑÊµãË∑ØÂæÑ:', predictedPath);
                    return predictedPath;
                }
                
                // ÊñπÊ≥ï2: Âü∫‰∫éÊñá‰ª∂Â§πÂêçÁß∞Ê®°ÂºèÁöÑÈ¢ÑÊµã
                const patternPath = predictPathFromFolderPattern(folderName);
                if (patternPath) {
                    console.log('Âü∫‰∫éÊñá‰ª∂Â§πÊ®°ÂºèÈ¢ÑÊµãË∑ØÂæÑ:', patternPath);
                    return patternPath;
                }
                
                // ÊñπÊ≥ï3: Â∞ùËØï‰ªéÁ¨¨‰∏Ä‰∏™Êñá‰ª∂Ëé∑ÂèñwebkitRelativePath
                try {
                    for await (const entry of dirHandle.values()) {
                        if (entry.kind === 'file') {
                            const file = await entry.getFile();
                            if (file.webkitRelativePath) {
                                const pathParts = file.webkitRelativePath.split('/');
                                pathParts.pop(); // ÁßªÈô§Êñá‰ª∂Âêç
                                if (pathParts.length > 0) {
                                    return pathParts.join('\\');
                                }
                            }
                            break; // Âè™Ê£ÄÊü•Á¨¨‰∏Ä‰∏™Êñá‰ª∂
                        }
                    }
                } catch (fileError) {
                    console.warn('Êó†Ê≥ï‰ªéÊñá‰ª∂Ëé∑ÂèñË∑ØÂæÑ:', fileError);
                }
                
                // ÊñπÊ≥ï4: ÈªòËÆ§Êô∫ËÉΩÊé®Êµã
                const username = getUsername();
                return `C:\\Users\\${username}\\Desktop\\${folderName}`;
                
            } catch (error) {
                console.warn('Êó†Ê≥ïËé∑ÂèñÂÆåÊï¥Ë∑ØÂæÑ:', error);
                return null;
            }
        }
        
        // Âü∫‰∫éÂéÜÂè≤ËÆ∞ÂΩïÈ¢ÑÊµãË∑ØÂæÑ
        function predictPathFromHistory(folderName) {
            try {
                const pathHistory = JSON.parse(localStorage.getItem('pathHistory') || '[]');
                const pathPatterns = JSON.parse(localStorage.getItem('pathPatterns') || '{}');
                
                // Êü•ÊâæÁõ∏‰ººÁöÑÊñá‰ª∂Â§πÂêçÁß∞
                for (const historyPath of pathHistory) {
                    const historyFolder = historyPath.split('\\').pop();
                    
                    // Â¶ÇÊûúÊâæÂà∞Áõ∏ÂêåÁöÑÊñá‰ª∂Â§πÂêç
                    if (historyFolder === folderName) {
                        return historyPath;
                    }
                    
                    // Â¶ÇÊûúÊâæÂà∞Áõ∏‰ººÁöÑÊñá‰ª∂Â§πÂêçÔºàÂåÖÂê´ÂÖ≥ÈîÆËØçÔºâ
                    if (historyFolder && folderName && 
                        (historyFolder.includes(folderName) || folderName.includes(historyFolder))) {
                        const basePath = historyPath.substring(0, historyPath.lastIndexOf('\\'));
                        return `${basePath}\\${folderName}`;
                    }
                }
                
                // Âü∫‰∫éË∑ØÂæÑÊ®°ÂºèÈ¢ÑÊµã
                const mostCommonPattern = Object.keys(pathPatterns).reduce((a, b) => 
                    pathPatterns[a] > pathPatterns[b] ? a : b, Object.keys(pathPatterns)[0]);
                
                if (mostCommonPattern) {
                    return `${mostCommonPattern}\\${folderName}`;
                }
                
                return null;
            } catch (error) {
                console.warn('ÂéÜÂè≤È¢ÑÊµãÂ§±Ë¥•:', error);
                return null;
            }
        }
        
        // Âü∫‰∫éÊñá‰ª∂Â§πÂêçÁß∞Ê®°ÂºèÈ¢ÑÊµãË∑ØÂæÑ
        function predictPathFromFolderPattern(folderName) {
            const patterns = [
                // ÊµãËØïÁõ∏ÂÖ≥
                { keywords: ['ÊµãËØï', 'test', 'Test'], basePath: 'E:\\WXWork\\5.0.0.8002\\bugly\\x64' },
                // ‰∏ãËΩΩÁõ∏ÂÖ≥
                { keywords: ['‰∏ãËΩΩ', 'download', 'Download'], basePath: `C:\\Users\\${getUsername()}\\Downloads` },
                // Ê°åÈù¢Áõ∏ÂÖ≥
                { keywords: ['Ê°åÈù¢', 'desktop', 'Desktop'], basePath: `C:\\Users\\${getUsername()}\\Desktop` },
                // ÊñáÊ°£Áõ∏ÂÖ≥
                { keywords: ['ÊñáÊ°£', 'document', 'Document'], basePath: `C:\\Users\\${getUsername()}\\Documents` },
                // È°πÁõÆÁõ∏ÂÖ≥
                { keywords: ['È°πÁõÆ', 'project', 'Project', 'work', 'Work'], basePath: 'D:\\Projects' },
                // ‰π¶Á±çÁõ∏ÂÖ≥
                { keywords: ['‰π¶', 'Â∞èËØ¥', 'book', 'novel', 'ÈòÖËØª'], basePath: 'E:\\Books' }
            ];
            
            for (const pattern of patterns) {
                for (const keyword of pattern.keywords) {
                    if (folderName.toLowerCase().includes(keyword.toLowerCase())) {
                        return `${pattern.basePath}\\${folderName}`;
                    }
                }
            }
            
            return null;
        }
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºàÂ∞ùËØï‰ªéÂêÑÁßçÊù•Ê∫êÔºâ
        function getUsername() {
            try {
                // Â∞ùËØï‰ªéÂêÑÁßçÂèØËÉΩÁöÑÊù•Ê∫êËé∑ÂèñÁî®Êà∑Âêç
                
                // ÊñπÊ≥ï1: ‰ªélocalStorageËé∑Âèñ‰πãÂâç‰øùÂ≠òÁöÑÁî®Êà∑Âêç
                const savedUsername = localStorage.getItem('detectedUsername');
                if (savedUsername) {
                    return savedUsername;
                }
                
                // ÊñπÊ≥ï2: Â∞ùËØï‰ªénavigatorËé∑Âèñ‰∏Ä‰∫õ‰ø°ÊÅØ
                if (navigator.userAgentData && navigator.userAgentData.platform) {
                    console.log('Âπ≥Âè∞‰ø°ÊÅØ:', navigator.userAgentData.platform);
                }
                
                // ÊñπÊ≥ï3: Ê£ÄÊü•ÊòØÂê¶Âú®Â∏∏ËßÅÁöÑ‰∏≠ÊñáÁéØÂ¢É
                const isChineseEnv = navigator.language && navigator.language.includes('zh');
                
                // ËøîÂõûÊõ¥ÂêàÈÄÇÁöÑÈªòËÆ§Áî®Êà∑Âêç
                return isChineseEnv ? 'Áî®Êà∑' : 'User';
            } catch (error) {
                return 'User';
            }
        }
        
        // Êô∫ËÉΩÊ£ÄÊµãÂπ∂‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
        function detectAndSaveUserInfo() {
            // Â¶ÇÊûúÁî®Êà∑‰πãÂâçËÆæÁΩÆËøáÂÆåÊï¥Ë∑ØÂæÑÔºå‰ªé‰∏≠ÊèêÂèñÁî®Êà∑Âêç
            if (fullBasePath && fullBasePath.includes('C:\\Users\\')) {
                const match = fullBasePath.match(/C:\\Users\\([^\\]+)\\/);
                if (match && match[1]) {
                    const detectedUsername = match[1];
                    localStorage.setItem('detectedUsername', detectedUsername);
                    console.log('‰ªéË∑ØÂæÑ‰∏≠Ê£ÄÊµãÂà∞Áî®Êà∑Âêç:', detectedUsername);
                    return detectedUsername;
                }
            }
            return null;
        }
        
        // ÁîüÊàêÊô∫ËÉΩË∑ØÂæÑÂª∫ËÆÆ
        function generateSmartSuggestions(folderName, username) {
            const suggestions = [];
            
            try {
                // 1. ‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºöÂÆåÂÖ®ÂåπÈÖçÁöÑÊñá‰ª∂Â§πÂêç
                const folderPatterns = JSON.parse(localStorage.getItem('folderPatterns') || '{}');
                if (folderPatterns[folderName]) {
                    suggestions.push(`${folderPatterns[folderName].basePath}\\${folderName} (Êô∫ËÉΩÊé®Ëçê)`);
                }
                
                // 2. Âü∫‰∫éÁõ∏‰ººÊñá‰ª∂Â§πÂêçÁöÑÈ¢ÑÊµã
                Object.keys(folderPatterns).forEach(savedFolder => {
                    if (savedFolder !== folderName && 
                        (savedFolder.includes(folderName) || folderName.includes(savedFolder))) {
                        const basePath = folderPatterns[savedFolder].basePath;
                        const suggestedPath = `${basePath}\\${folderName} (Áõ∏‰ººÊé®Ëçê)`;
                        if (!suggestions.includes(suggestedPath)) {
                            suggestions.push(suggestedPath);
                        }
                    }
                });
                
                // 3. Âü∫‰∫éÊúÄÂ∏∏Áî®ÁöÑÂü∫Á°ÄË∑ØÂæÑ
                const pathPatterns = JSON.parse(localStorage.getItem('pathPatterns') || '{}');
                const sortedPatterns = Object.keys(pathPatterns)
                    .sort((a, b) => pathPatterns[b] - pathPatterns[a])
                    .slice(0, 3);
                
                sortedPatterns.forEach(basePath => {
                    const suggestedPath = `${basePath}\\${folderName} (Â∏∏Áî®‰ΩçÁΩÆ)`;
                    if (!suggestions.some(s => s.includes(basePath))) {
                        suggestions.push(suggestedPath);
                    }
                });
                
                // 4. ÊúÄËøë‰ΩøÁî®ÁöÑË∑ØÂæÑÔºà‰øÆÊîπ‰∏∫ÂΩìÂâçÊñá‰ª∂Â§πÂêçÔºâ
                const pathHistory = JSON.parse(localStorage.getItem('pathHistory') || '[]');
                pathHistory.slice(0, 2).forEach(historyPath => {
                    const basePath = historyPath.substring(0, historyPath.lastIndexOf('\\'));
                    const suggestedPath = `${basePath}\\${folderName} (ÊúÄËøë‰ΩçÁΩÆ)`;
                    if (!suggestions.some(s => s.includes(basePath))) {
                        suggestions.push(suggestedPath);
                    }
                });
                
            } catch (error) {
                console.warn('ÁîüÊàêÊô∫ËÉΩÂª∫ËÆÆÂ§±Ë¥•:', error);
            }
            
            // 5. Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊ∑ªÂä†Âü∫‰∫éÊñá‰ª∂Â§πÂêçÁöÑÊô∫ËÉΩÈ¢ÑÊµã
            if (suggestions.length === 0) {
                const patternPath = predictPathFromFolderPattern(folderName);
                if (patternPath) {
                    suggestions.push(`${patternPath} (Ê®°ÂºèÂåπÈÖç)`);
                }
            }
            
            // 6. Ê∑ªÂä†Â∏∏ËßÅÁöÑÈªòËÆ§Ë∑ØÂæÑÔºàÈÅøÂÖçÈáçÂ§çÔºâ
            const defaultPaths = [
                `C:\\Users\\${username}\\Desktop\\${folderName}`,
                `C:\\Users\\${username}\\Documents\\${folderName}`,
                `C:\\Users\\${username}\\Downloads\\${folderName}`,
                `D:\\${folderName}`,
                `E:\\${folderName}`
            ];
            
            defaultPaths.forEach(path => {
                const basePath = path.substring(0, path.lastIndexOf('\\'));
                if (!suggestions.some(s => s.includes(basePath))) {
                    suggestions.push(path);
                }
            });
            
            // 7. Ê∑ªÂä†Ëá™ÂÆö‰πâÈÄâÈ°π
            suggestions.push('Ëá™ÂÆö‰πâË∑ØÂæÑ...');
            
            return suggestions.slice(0, 8); // ÊúÄÂ§öÊòæÁ§∫8‰∏™ÈÄâÈ°π
        }

        // ËÆæÁΩÆÂÆåÊï¥Âü∫Á°ÄË∑ØÂæÑ
        function setBasePath() {
            if (!currentDirHandle) {
                alert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂Â§π');
                return;
            }
            
            const folderName = currentDirHandle.name;
            const username = getUsername();
            
            // ÁîüÊàêÊô∫ËÉΩÂª∫ËÆÆ
            const suggestions = generateSmartSuggestions(folderName, username);
            
            const currentPath = fullBasePath || suggestions[0];
            
            let message = `ËØ∑ÈÄâÊã©ÊàñËæìÂÖ•Êñá‰ª∂Â§πÁöÑÂÆåÊï¥Ë∑ØÂæÑÔºö\n\n`;
            message += `Â∏∏Áî®Ë∑ØÂæÑÈÄâÈ°πÔºö\n`;
            suggestions.forEach((path, index) => {
                message += `${index + 1}. ${path}\n`;
            });
            message += `\nËØ∑ËæìÂÖ•ÈÄâÈ°πÁºñÂè∑(1-${suggestions.length})ÊàñÁõ¥Êé•ËæìÂÖ•ÂÆåÊï¥Ë∑ØÂæÑÔºö`;
            
            const userInput = prompt(message, '1');
            
            if (userInput && userInput.trim()) {
                const input = userInput.trim();
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊï∞Â≠óÈÄâÊã©
                const optionNum = parseInt(input);
                if (optionNum >= 1 && optionNum <= suggestions.length) {
                    if (optionNum === suggestions.length) {
                        // ÈÄâÊã©‰∫Ü"Ëá™ÂÆö‰πâË∑ØÂæÑ"
                        const customPath = prompt('ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁöÑÊñá‰ª∂Â§πË∑ØÂæÑÔºö', currentPath);
                        if (customPath && customPath.trim()) {
                            fullBasePath = customPath.trim();
                        }
                    } else {
                        // ÈÄâÊã©‰∫ÜÈ¢ÑËÆæË∑ØÂæÑ
                        fullBasePath = suggestions[optionNum - 1];
                    }
                } else {
                    // Áõ¥Êé•ËæìÂÖ•‰∫ÜË∑ØÂæÑ
                    fullBasePath = input;
                }
                
                if (fullBasePath) {
                    // ‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï
                    savePathToHistory(fullBasePath);
                    
                    // Â∞ùËØï‰ªéË∑ØÂæÑ‰∏≠Ê£ÄÊµãÁî®Êà∑Âêç
                    detectAndSaveUserInfo();
                    
                    showSuccess(`Â∑≤ËÆæÁΩÆÂÆåÊï¥Ë∑ØÂæÑÔºö${fullBasePath}`);
                    console.log('ËÆæÁΩÆÁöÑÂÆåÊï¥Ë∑ØÂæÑ:', fullBasePath);
                    
                    // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑÊòæÁ§∫
                    updateCurrentPath();
                }
            }
        }
        
        // ‰øùÂ≠òË∑ØÂæÑÂà∞ÂéÜÂè≤ËÆ∞ÂΩïÂπ∂Â≠¶‰π†Ê®°Âºè
        function savePathToHistory(path) {
            try {
                // ‰øùÂ≠òÂÆåÊï¥Ë∑ØÂæÑÂéÜÂè≤
                let pathHistory = JSON.parse(localStorage.getItem('pathHistory') || '[]');
                pathHistory = pathHistory.filter(p => p !== path);
                pathHistory.unshift(path);
                pathHistory = pathHistory.slice(0, 10);
                localStorage.setItem('pathHistory', JSON.stringify(pathHistory));
                
                // Â≠¶‰π†Ë∑ØÂæÑÊ®°ÂºèÔºàÊèêÂèñÂü∫Á°ÄË∑ØÂæÑÔºâ
                const basePath = path.substring(0, path.lastIndexOf('\\'));
                let pathPatterns = JSON.parse(localStorage.getItem('pathPatterns') || '{}');
                pathPatterns[basePath] = (pathPatterns[basePath] || 0) + 1;
                localStorage.setItem('pathPatterns', JSON.stringify(pathPatterns));
                
                // Â≠¶‰π†Êñá‰ª∂Â§πÂêçÁß∞Ê®°Âºè
                const folderName = path.split('\\').pop();
                let folderPatterns = JSON.parse(localStorage.getItem('folderPatterns') || '{}');
                folderPatterns[folderName] = {
                    basePath: basePath,
                    count: (folderPatterns[folderName]?.count || 0) + 1,
                    lastUsed: Date.now()
                };
                localStorage.setItem('folderPatterns', JSON.stringify(folderPatterns));
                
                console.log('Ë∑ØÂæÑÂ∑≤‰øùÂ≠òÂπ∂Â≠¶‰π†Ê®°Âºè:', path);
                console.log('Âü∫Á°ÄË∑ØÂæÑ‰ΩøÁî®Ê¨°Êï∞:', pathPatterns[basePath]);
            } catch (error) {
                console.warn('‰øùÂ≠òË∑ØÂæÑÂéÜÂè≤Â§±Ë¥•:', error);
            }
        }
        
        // Ê∏ÖÈô§Ë∑ØÂæÑÂéÜÂè≤ËÆ∞ÂΩï
        function clearPathHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË∑ØÂæÑÂéÜÂè≤ËÆ∞ÂΩïÂíåÂ≠¶‰π†ÁöÑÊ®°ÂºèÂêóÔºüËøôÂ∞ÜÈáçÁΩÆÊô∫ËÉΩÊé®ËçêÁ≥ªÁªü„ÄÇ')) {
                localStorage.removeItem('pathHistory');
                localStorage.removeItem('pathPatterns');
                localStorage.removeItem('folderPatterns');
                localStorage.removeItem('detectedUsername');
                showSuccess('Ë∑ØÂæÑÂéÜÂè≤ËÆ∞ÂΩïÂíåÊô∫ËÉΩÊ®°ÂºèÂ∑≤Ê∏ÖÈô§');
            }
        }

        // ÈÄâÊã©Êñá‰ª∂Â§π
        async function selectFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                currentDirHandle = dirHandle;
                currentPath = [dirHandle.name];
                
                // Â∞ùËØïËé∑ÂèñÂÆåÊï¥Ë∑ØÂæÑ
                showLoading('Ê≠£Âú®Ëé∑ÂèñË∑ØÂæÑ‰ø°ÊÅØ...');
                const detectedPath = await getFullPath(dirHandle);
                if (detectedPath) {
                    fullBasePath = detectedPath;
                    console.log('Êô∫ËÉΩÊé®ÊµãÁöÑË∑ØÂæÑ:', fullBasePath);
                    
                    // ËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶Ë¶Å‰øÆÊ≠£Ë∑ØÂæÑ
                    setTimeout(() => {
                        if (confirm(`Á≥ªÁªüÊé®ÊµãÁöÑÊñá‰ª∂Â§πË∑ØÂæÑ‰∏∫Ôºö\n${fullBasePath}\n\nÊòØÂê¶Ê≠£Á°ÆÔºüÁÇπÂáª"ÂèñÊ∂à"Êù•ÊâãÂä®ËÆæÁΩÆÊ≠£Á°ÆË∑ØÂæÑ„ÄÇ`)) {
                            showSuccess(`Â∑≤‰ΩøÁî®Êé®ÊµãË∑ØÂæÑÔºö${fullBasePath}`);
                        } else {
                            setBasePath();
                        }
                    }, 1000);
                } else {
                    // Â¶ÇÊûúÊó†Ê≥ïËé∑ÂèñÂÆåÊï¥Ë∑ØÂæÑÔºå‰ΩøÁî®Êñá‰ª∂Â§πÂêç‰Ωú‰∏∫Âü∫Á°ÄË∑ØÂæÑ
                    fullBasePath = `[${dirHandle.name}]`;
                    console.log('‰ΩøÁî®Êñá‰ª∂Â§πÂêç‰Ωú‰∏∫Âü∫Á°ÄË∑ØÂæÑ:', fullBasePath);
                    
                    // ÊèêÁ§∫Áî®Êà∑ÂèØ‰ª•ËÆæÁΩÆÂÆåÊï¥Ë∑ØÂæÑ
                    setTimeout(() => {
                        if (confirm(`Êó†Ê≥ïËá™Âä®Ê£ÄÊµãÂÆåÊï¥Ë∑ØÂæÑ„ÄÇ\nÂΩìÂâç‰ΩøÁî®Ôºö${fullBasePath}\n\nÊòØÂê¶Ë¶ÅËÆæÁΩÆÂÆåÊï¥ÁöÑÊñá‰ª∂Â§πË∑ØÂæÑ‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑÂØºÂá∫ÊïàÊûúÔºü`)) {
                            setBasePath();
                        }
                    }, 1000);
                }
                
                updateCurrentPath();
                showLoading('Ê≠£Âú®Êâ´ÊèèÊñá‰ª∂Â§πÁªìÊûÑ...');
                
                folderStructure = await scanDirectory(dirHandle, 0);
                displayFolderTree(folderStructure);
                displayCurrentFolder(folderStructure);
                updateStats(folderStructure);
                
                showSuccess('Êñá‰ª∂Â§πÊâ´ÊèèÂÆåÊàêÔºÅ');
                
            } catch (error) {
                console.error('ÈÄâÊã©Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                if (error.name === 'AbortError') {
                    showError('Áî®Êà∑ÂèñÊ∂à‰∫ÜÊñá‰ª∂Â§πÈÄâÊã©');
                } else {
                    showError('ÈÄâÊã©Êñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                }
            }
        }
        
        // Êâ´ÊèèÁõÆÂΩïÁªìÊûÑ
        async function scanDirectory(dirHandle, level = 0, parent = null) {
            const result = {
                id: generateId(),
                name: dirHandle.name,
                path: dirHandle.path || '',
                type: 'folder',
                children: [],
                level: level,
                handle: dirHandle,
                parent: parent
            };
            
            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'directory') {
                        const child = await scanDirectory(entry, level + 1, result);
                        result.children.push(child);
                    } else if (isBookFile(entry.name)) {
                        result.children.push({
                            id: generateId(),
                            name: entry.name,
                            type: 'file',
                            level: level + 1,
                            handle: entry,
                            parent: result
                        });
                    }
                }
            } catch (error) {
                console.warn('Êâ´ÊèèÊñá‰ª∂Â§πÂ§±Ë¥•:', dirHandle.name, error);
            }
            
            return result;
        }
        
        // Âà§Êñ≠ÊòØÂê¶‰∏∫‰π¶Á±çÊñá‰ª∂ÔºàÁé∞Âú®ÊîØÊåÅÊâÄÊúâÊñá‰ª∂Ôºâ
        function isBookFile(filename) {
            // ÊîØÊåÅÊâÄÊúâÊñá‰ª∂Á±ªÂûã
            return true;
        }
        
        // ÁîüÊàêÂîØ‰∏ÄID
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ÊòæÁ§∫Êñá‰ª∂Â§πÊ†ë
        function displayFolderTree(structure) {
            const treeContainer = document.getElementById('folderTree');
            
            function renderNode(node) {
                const tagType = getTagType(node.level);
                const className = `tag-${Math.min(node.level, 3)}`;
                
                let childrenHtml = '';
                if (node.children && node.children.length > 0) {
                    childrenHtml = node.children.map(child => renderNode(child)).join('');
                }
                
                return `
                    <div class="folder-node ${className}" onclick="selectNode('${node.id}')" data-id="${node.id}">
                        <span class="tag-type">${tagType}</span>
                        <span class="folder-name">${node.name}</span>
                        ${node.children ? `<span class="file-count">(${node.children.length})</span>` : ''}
                    </div>
                    ${childrenHtml}
                `;
            }
            
            treeContainer.innerHTML = renderNode(structure);
        }
        
        // Ëé∑ÂèñÊ†áÁ≠æÁ±ªÂûã
        function getTagType(level) {
            const types = ['Â§ßÊ†áÁ≠æ', '‰∏≠Ê†áÁ≠æ', 'Â∞èÊ†áÁ≠æ', 'ÂæÆÊ†áÁ≠æ'];
            return types[Math.min(level, types.length - 1)];
        }
        
        // ÈÄâÊã©ËäÇÁÇπ
        function selectNode(nodeId) {
            const node = findNodeById(folderStructure, nodeId);
            if (node) {
                // Ê∑ªÂä†Âà∞ÂØºËà™ÂéÜÂè≤
                navigationHistory.push(node);
                currentHistoryIndex++;
                
                displayCurrentFolder(node);
                updateBreadcrumb(node);
                updateBackButton();
            }
        }
        
        // Ê†πÊçÆIDÊü•ÊâæËäÇÁÇπ
        function findNodeById(structure, id) {
            if (structure.id === id) {
                return structure;
            }
            
            if (structure.children) {
                for (const child of structure.children) {
                    const found = findNodeById(child, id);
                    if (found) return found;
                }
            }
            
            return null;
        }
        
        // ÊòæÁ§∫ÂΩìÂâçÊñá‰ª∂Â§πÂÜÖÂÆπ
        function displayCurrentFolder(node) {
            const container = document.getElementById('currentFolder');
            
            if (!node.children || node.children.length === 0) {
                container.innerHTML = '<div class="loading">Ê≠§Êñá‰ª∂Â§π‰∏∫Á©∫</div>';
                // ÈöêËóèÂØºÂá∫ÊåâÈíÆ
                document.getElementById('exportBtn').style.display = 'none';
                return;
            }
            
            // ÊòæÁ§∫ÂØºÂá∫ÊåâÈíÆ
            document.getElementById('exportBtn').style.display = 'inline-block';
            
            let html = `<h3>üìÅ ${node.name} ÁöÑÂÜÖÂÆπ</h3>`;
            
            // ÂàÜÁ±ªÊòæÁ§∫
            const folders = node.children.filter(item => item.type === 'folder');
            const files = node.children.filter(item => item.type === 'file');
            
            if (folders.length > 0) {
                html += '<h4>üìÇ Â≠êÊñá‰ª∂Â§π</h4>';
                folders.forEach(folder => {
                    html += `
                        <div class="folder-node tag-${Math.min(folder.level, 3)}" onclick="selectNode('${folder.id}')">
                            üìÅ ${folder.name} (${folder.children ? folder.children.length : 0}È°π)
                        </div>
                    `;
                });
            }
            
            if (files.length > 0) {
                html += '<h4>üìÑ Êñá‰ª∂ÂàóË°®</h4>';
                files.forEach((file, index) => {
                    const isSelected = selectedFiles.has(file.id);
                    const selectedClass = isSelected ? 'selected' : '';
                    html += `
                        <div class="file-item ${selectedClass}" data-file-id="${file.id}" data-file-index="${index}">
                            <div class="file-info">
                                <input type="checkbox" class="file-checkbox" id="file_${file.id}" 
                                       ${isSelected ? 'checked' : ''}>
                                <span class="file-icon">üìÑ</span>
                                <span>${file.name}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
            
            // Ê∑ªÂä†ÊªëÂä®Â§öÈÄâ‰∫ã‰ª∂
            addDragSelection();
        }
        
        // ÊâìÂºÄÊñá‰ª∂
        async function openFile(fileId) {
            const node = findNodeById(folderStructure, fileId);
            if (node && node.handle) {
                try {
                    const file = await node.handle.getFile();
                    const url = URL.createObjectURL(file);
                    window.open(url, '_blank');
                } catch (error) {
                    showError('Êó†Ê≥ïÊâìÂºÄÊñá‰ª∂: ' + error.message);
                }
            }
        }
        
        // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
        function updateBreadcrumb(node) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.style.display = 'block';
            
            // ÊûÑÂª∫‰ªéÊ†πÁõÆÂΩïÂà∞ÂΩìÂâçËäÇÁÇπÁöÑÂÆåÊï¥Ë∑ØÂæÑ
            const path = [];
            let current = node;
            while (current) {
                path.unshift(current);
                current = current.parent;
            }
            
            let html = '';
            path.forEach((pathNode, index) => {
                if (index > 0) {
                    html += '<span class="separator">></span>';
                }
                html += `<span onclick="navigateToPathNode('${pathNode.id}')" style="cursor: pointer; color: #667eea;">${pathNode.name}</span>`;
            });
            
            breadcrumb.innerHTML = html;
        }
        
        // ÂØºËà™Âà∞ÊåáÂÆöÁöÑË∑ØÂæÑËäÇÁÇπ
        function navigateToPathNode(nodeId) {
            const targetNode = findNodeById(folderStructure, nodeId);
            if (targetNode) {
                // ÊûÑÂª∫Âà∞ÁõÆÊ†áËäÇÁÇπÁöÑÂÆåÊï¥Ë∑ØÂæÑ
                const pathToTarget = [];
                let current = targetNode;
                while (current) {
                    pathToTarget.unshift(current);
                    current = current.parent;
                }
                
                // Ê∏ÖÁ©∫ÂΩìÂâçÂéÜÂè≤ÔºåÈáçÊñ∞ÊûÑÂª∫
                navigationHistory = [];
                currentHistoryIndex = -1;
                
                // ÈÄêÁ∫ßÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                pathToTarget.forEach((pathNode, index) => {
                    navigationHistory.push(pathNode);
                    currentHistoryIndex = index;
                });
                
                displayCurrentFolder(targetNode);
                updateBreadcrumb(targetNode);
                updateBackButton();
            }
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(structure) {
            const stats = document.getElementById('stats');
            stats.style.display = 'grid';
            
            const folderCount = countFolders(structure);
            const fileCount = countFiles(structure);
            const levelCount = getMaxLevel(structure);
            
            document.getElementById('folderCount').textContent = folderCount;
            document.getElementById('fileCount').textContent = fileCount;
            document.getElementById('levelCount').textContent = levelCount;
        }
        
        // ÁªüËÆ°Êñá‰ª∂Â§πÊï∞Èáè
        function countFolders(node) {
            let count = 1; // ÂΩìÂâçËäÇÁÇπ
            if (node.children) {
                node.children.forEach(child => {
                    if (child.type === 'folder') {
                        count += countFolders(child);
                    }
                });
            }
            return count;
        }
        
        // ÁªüËÆ°Êñá‰ª∂Êï∞Èáè
        function countFiles(node) {
            let count = 0;
            if (node.children) {
                node.children.forEach(child => {
                    if (child.type === 'file') {
                        count++;
                    } else {
                        count += countFiles(child);
                    }
                });
            }
            return count;
        }
        
        // Ëé∑ÂèñÊúÄÂ§ßÂ±ÇÁ∫ß
        function getMaxLevel(node) {
            let maxLevel = node.level;
            if (node.children) {
                node.children.forEach(child => {
                    maxLevel = Math.max(maxLevel, getMaxLevel(child));
                });
            }
            return maxLevel + 1;
        }
        
        // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑÊòæÁ§∫
        function updateCurrentPath() {
            const pathElement = document.getElementById('currentPath');
            pathElement.textContent = currentPath.join(' > ');
        }
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        function showLoading(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="loading">${message}</div>`;
        }
        
        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccess(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="success">${message}</div>`;
        }
        
        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showError(message) {
            const container = document.getElementById('currentFolder');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // ÂàáÊç¢Êñá‰ª∂ÈÄâÊã©Áä∂ÊÄÅ
        function toggleFileSelection(fileId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            
            if (selectedFiles.has(fileId)) {
                selectedFiles.delete(fileId);
                fileItem.classList.remove('selected');
            } else {
                selectedFiles.add(fileId);
                fileItem.classList.add('selected');
            }
            
            lastSelectedFile = fileId;
            updateBatchActions();
        }
        
        // Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊ†è
        function updateBatchActions() {
            const batchActions = document.getElementById('batchActions');
            const selectedCount = document.getElementById('selectedCount');
            
            console.log('Êõ¥Êñ∞ÊâπÈáèÊìç‰ΩúÊ†èÔºåÈÄâÊã©ÁöÑÊñá‰ª∂Êï∞Èáè:', selectedFiles.size);
            
            if (selectedFiles.size > 0) {
                batchActions.classList.add('show');
                selectedCount.textContent = `Â∑≤ÈÄâÊã© ${selectedFiles.size} ‰∏™Êñá‰ª∂`;
                console.log('ÊòæÁ§∫ÊâπÈáèÊìç‰ΩúÊ†è');
            } else {
                batchActions.classList.remove('show');
                console.log('ÈöêËóèÊâπÈáèÊìç‰ΩúÊ†è');
            }
        }
        
        // ÂÖ®ÈÄâÊñá‰ª∂
        function selectAllFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const fileId = checkbox.id.replace('file_', '');
                selectedFiles.add(fileId);
            });
            updateBatchActions();
        }
        
        // ÂèñÊ∂àÂÖ®ÈÄâ
        function deselectAllFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedFiles.clear();
            updateBatchActions();
        }
        
        // ÊòæÁ§∫ËΩ¨ÁßªÂØπËØùÊ°Ü
        function showMoveDialog() {
            if (selectedFiles.size === 0) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅËΩ¨ÁßªÁöÑÊñá‰ª∂');
                return;
            }
            
            document.getElementById('moveDialog').classList.add('show');
            targetFolderHandle = null;
            document.getElementById('targetFolderPath').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('moveStatus').innerHTML = '';
        }
        
        // ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π
        async function selectTargetFolder() {
            try {
                const dirHandle = await window.showDirectoryPicker();
                targetFolderHandle = dirHandle;
                document.getElementById('targetFolderPath').textContent = dirHandle.name;
                document.getElementById('targetFolderPath').style.display = 'block';
            } catch (error) {
                if (error.name !== 'AbortError') {
                    alert('ÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§πÂ§±Ë¥•: ' + error.message);
                }
            }
        }
        
        // ÂÖ≥Èó≠ËΩ¨ÁßªÂØπËØùÊ°Ü
        function closeMoveDialog() {
            document.getElementById('moveDialog').classList.remove('show');
            targetFolderHandle = null;
        }
        
        // ÊâßË°åÊñá‰ª∂ËΩ¨Áßª
        async function executeMove() {
            if (!targetFolderHandle) {
                alert('ËØ∑ÂÖàÈÄâÊã©ÁõÆÊ†áÊñá‰ª∂Â§π');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmMoveBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const moveStatus = document.getElementById('moveStatus');
            
            confirmBtn.disabled = true;
            progressBar.style.display = 'block';
            moveStatus.innerHTML = '<p>Ê≠£Âú®ËΩ¨ÁßªÊñá‰ª∂...</p>';
            
            let successCount = 0;
            let failCount = 0;
            const totalFiles = selectedFiles.size;
            let currentIndex = 0;
            
            for (const fileId of selectedFiles) {
                try {
                    const fileNode = findNodeById(folderStructure, fileId);
                    if (fileNode && fileNode.handle) {
                        // Ëé∑ÂèñÊ∫êÊñá‰ª∂
                        const sourceFile = await fileNode.handle.getFile();
                        
                        // Ê£ÄÊü•ÁõÆÊ†áÊñá‰ª∂Â§π‰∏≠ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÊñá‰ª∂
                        let targetFileName = fileNode.name;
                        let counter = 1;
                        
                        while (true) {
                            try {
                                await targetFolderHandle.getFileHandle(targetFileName);
                                // Êñá‰ª∂Â∑≤Â≠òÂú®ÔºåÈáçÂëΩÂêç
                                const nameParts = fileNode.name.split('.');
                                const ext = nameParts.pop();
                                const baseName = nameParts.join('.');
                                targetFileName = `${baseName}_${counter}.${ext}`;
                                counter++;
                            } catch {
                                // Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™ÂêçÁß∞
                                break;
                            }
                        }
                        
                        // ÂàõÂª∫Êñ∞Êñá‰ª∂
                        const targetFileHandle = await targetFolderHandle.getFileHandle(targetFileName, { create: true });
                        const writable = await targetFileHandle.createWritable();
                        
                        // ÂÜôÂÖ•Êñá‰ª∂ÂÜÖÂÆπ
                        await writable.write(sourceFile);
                        await writable.close();
                        
                        // Âà†Èô§ÂéüÊñá‰ª∂
                        await fileNode.handle.remove();
                        
                        successCount++;
                    }
                } catch (error) {
                    console.error('ËΩ¨ÁßªÊñá‰ª∂Â§±Ë¥•:', error);
                    failCount++;
                }
                
                currentIndex++;
                const progress = (currentIndex / totalFiles) * 100;
                progressFill.style.width = progress + '%';
                
                moveStatus.innerHTML = `
                    <p>Ê≠£Âú®ËΩ¨ÁßªÊñá‰ª∂... (${currentIndex}/${totalFiles})</p>
                    <p>ÊàêÂäü: ${successCount}, Â§±Ë¥•: ${failCount}</p>
                `;
            }
            
            // ËΩ¨ÁßªÂÆåÊàê
            moveStatus.innerHTML = `
                <div class="success">
                    <p>ËΩ¨ÁßªÂÆåÊàêÔºÅ</p>
                    <p>ÊàêÂäü: ${successCount} ‰∏™Êñá‰ª∂</p>
                    <p>Â§±Ë¥•: ${failCount} ‰∏™Êñá‰ª∂</p>
                </div>
            `;
            
            // ÈáçÊñ∞Êâ´ÊèèÊñá‰ª∂Â§πÁªìÊûÑ
            if (currentDirHandle) {
                folderStructure = await scanDirectory(currentDirHandle, 0);
                displayFolderTree(folderStructure);
                displayCurrentFolder(folderStructure);
                updateStats(folderStructure);
            }
            
            // Ê∏ÖÁ©∫ÈÄâÊã©
            selectedFiles.clear();
            updateBatchActions();
            
            // 3ÁßíÂêéÂÖ≥Èó≠ÂØπËØùÊ°Ü
            setTimeout(() => {
                closeMoveDialog();
            }, 3000);
        }
        
        // Ê∑ªÂä†ÊªëÂä®Â§öÈÄâÂäüËÉΩ
        function addDragSelection() {
            const fileItems = document.querySelectorAll('.file-item');
            let isDragging = false;
            let startItem = null;
            let endItem = null;
            let lastSelectedIndex = -1;
            let dragStartTime = 0;
            let isNewSelection = false; // Ê†áËÆ∞ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÊ¨°ÈÄâÊã©
            
            fileItems.forEach((item, index) => {
                item.addEventListener('mousedown', function(e) {
                    if (e.target.classList.contains('file-checkbox')) return;
                    
                    const currentIndex = parseInt(this.dataset.fileIndex);
                    const currentTime = Date.now();
                    
                    // Âà§Êñ≠ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÊ¨°ÈÄâÊã©ÔºàÊó∂Èó¥Èó¥ÈöîÂ§ß‰∫é200msÊàñÊ≤°ÊúâÊåâ‰ΩèShiftÈîÆÔºâ
                    if (currentTime - dragStartTime > 200 || !isShiftPressed) {
                        isNewSelection = true;
                        // Â¶ÇÊûúÊòØÊñ∞ÈÄâÊã©‰∏îÊ≤°ÊúâÊåâShiftÈîÆÔºåÊ∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©
                        if (!isShiftPressed) {
                            selectedFiles.clear();
                            document.querySelectorAll('.file-item').forEach(item => {
                                item.classList.remove('selected');
                                item.querySelector('.file-checkbox').checked = false;
                            });
                        }
                    } else {
                        isNewSelection = false;
                    }
                    
                    dragStartTime = currentTime;
                    
                    // Â¶ÇÊûúÊåâ‰ΩèShiftÈîÆÔºåËøõË°åËåÉÂõ¥ÈÄâÊã©
                    if (isShiftPressed && lastSelectedIndex !== -1 && !isNewSelection) {
                        const minIndex = Math.min(currentIndex, lastSelectedIndex);
                        const maxIndex = Math.max(currentIndex, lastSelectedIndex);
                        
                        // ‰∏çÊ∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©ÔºåËÄåÊòØÊ∑ªÂä†Âà∞Áé∞ÊúâÈÄâÊã©‰∏≠
                        for (let i = minIndex; i <= maxIndex; i++) {
                            const targetItem = document.querySelector(`[data-file-index="${i}"]`);
                            if (targetItem) {
                                const fileId = targetItem.dataset.fileId;
                                selectedFiles.add(fileId);
                                targetItem.classList.add('selected');
                                targetItem.querySelector('.file-checkbox').checked = true;
                            }
                        }
                        updateBatchActions();
                    } else {
                        // ÊôÆÈÄöÁÇπÂáªÈÄâÊã©
                        const fileId = this.dataset.fileId;
                        if (selectedFiles.has(fileId)) {
                            selectedFiles.delete(fileId);
                            this.classList.remove('selected');
                            this.querySelector('.file-checkbox').checked = false;
                        } else {
                            selectedFiles.add(fileId);
                            this.classList.add('selected');
                            this.querySelector('.file-checkbox').checked = true;
                        }
                        updateBatchActions();
                    }
                    
                    lastSelectedIndex = currentIndex;
                    isDragging = true;
                    startItem = this;
                    this.classList.add('selecting');
                });
                
                item.addEventListener('mouseenter', function(e) {
                    if (isDragging && this !== startItem) {
                        endItem = this;
                        this.classList.add('selecting');
                    }
                });
            });
            
            // ÁõëÂê¨Èº†Ê†áÁßªÂä®ÔºåÂÆûÁé∞Ëá™Âä®ÊªöÂä®ÈÄâÊã©
            const mainContent = document.querySelector('.main-content');
            let autoScrollInterval = null;
            
            // Âú®Êï¥‰∏™ÊñáÊ°£‰∏äÁõëÂê¨Èº†Ê†áÁßªÂä®ÔºåÁ°Æ‰øùÂç≥‰ΩøÊªëÂá∫ÂàóË°®Âå∫Âüü‰πüËÉΩÁªßÁª≠ÈÄâÊã©
            document.addEventListener('mousemove', function(e) {
                if (isDragging && startItem && lastSelectedIndex !== -1) {
                    const rect = mainContent.getBoundingClientRect();
                    const mouseY = e.clientY - rect.top;
                    const containerHeight = rect.height;
                    
                    // Â¶ÇÊûúÈº†Ê†áÂú®Â∫ïÈÉ®Âå∫ÂüüÔºåËá™Âä®Âêë‰∏ãÊªöÂä®
                    if (mouseY > containerHeight - 50) {
                        if (!autoScrollInterval) {
                            autoScrollInterval = setInterval(() => {
                                const currentScrollTop = mainContent.scrollTop;
                                mainContent.scrollTop = currentScrollTop + 10;
                                
                                // ÊâæÂà∞ÂΩìÂâçÂèØËßÅÂå∫ÂüüÁöÑÊñá‰ª∂
                                const visibleItems = Array.from(fileItems).filter(item => {
                                    const itemRect = item.getBoundingClientRect();
                                    const containerRect = mainContent.getBoundingClientRect();
                                    return itemRect.top >= containerRect.top && itemRect.bottom <= containerRect.bottom;
                                });
                                
                                if (visibleItems.length > 0) {
                                    const lastVisibleIndex = parseInt(visibleItems[visibleItems.length - 1].dataset.fileIndex);
                                    if (lastVisibleIndex > lastSelectedIndex) {
                                        // Êâ©Â±ïÈÄâÊã©ËåÉÂõ¥Ôºå‰∏çÊ∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©
                                        const minIndex = Math.min(lastSelectedIndex, lastVisibleIndex);
                                        const maxIndex = Math.max(lastSelectedIndex, lastVisibleIndex);
                                        
                                        // ÈÄâÊã©ËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÊñá‰ª∂ÔºåÊ∑ªÂä†Âà∞Áé∞ÊúâÈÄâÊã©‰∏≠
                                        for (let i = minIndex; i <= maxIndex; i++) {
                                            const targetItem = document.querySelector(`[data-file-index="${i}"]`);
                                            if (targetItem) {
                                                const fileId = targetItem.dataset.fileId;
                                                selectedFiles.add(fileId);
                                                targetItem.classList.add('selected');
                                                targetItem.querySelector('.file-checkbox').checked = true;
                                            }
                                        }
                                        updateBatchActions();
                                    }
                                }
                            }, 100);
                        }
                    } else if (mouseY < 50) {
                        // Â¶ÇÊûúÈº†Ê†áÂú®È°∂ÈÉ®Âå∫ÂüüÔºåËá™Âä®Âêë‰∏äÊªöÂä®
                        if (!autoScrollInterval) {
                            autoScrollInterval = setInterval(() => {
                                const currentScrollTop = mainContent.scrollTop;
                                mainContent.scrollTop = currentScrollTop - 10;
                                
                                // ÊâæÂà∞ÂΩìÂâçÂèØËßÅÂå∫ÂüüÁöÑÊñá‰ª∂
                                const visibleItems = Array.from(fileItems).filter(item => {
                                    const itemRect = item.getBoundingClientRect();
                                    const containerRect = mainContent.getBoundingClientRect();
                                    return itemRect.top >= containerRect.top && itemRect.bottom <= containerRect.bottom;
                                });
                                
                                if (visibleItems.length > 0) {
                                    const firstVisibleIndex = parseInt(visibleItems[0].dataset.fileIndex);
                                    if (firstVisibleIndex < lastSelectedIndex) {
                                        // Êâ©Â±ïÈÄâÊã©ËåÉÂõ¥Ôºå‰∏çÊ∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©
                                        const minIndex = Math.min(lastSelectedIndex, firstVisibleIndex);
                                        const maxIndex = Math.max(lastSelectedIndex, firstVisibleIndex);
                                        
                                        // ÈÄâÊã©ËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÊñá‰ª∂ÔºåÊ∑ªÂä†Âà∞Áé∞ÊúâÈÄâÊã©‰∏≠
                                        for (let i = minIndex; i <= maxIndex; i++) {
                                            const targetItem = document.querySelector(`[data-file-index="${i}"]`);
                                            if (targetItem) {
                                                const fileId = targetItem.dataset.fileId;
                                                selectedFiles.add(fileId);
                                                targetItem.classList.add('selected');
                                                targetItem.querySelector('.file-checkbox').checked = true;
                                            }
                                        }
                                        updateBatchActions();
                                    }
                                }
                            }, 100);
                        }
                    } else {
                        // Èº†Ê†áÂú®‰∏≠Èó¥Âå∫ÂüüÔºåÂÅúÊ≠¢Ëá™Âä®ÊªöÂä®
                        if (autoScrollInterval) {
                            clearInterval(autoScrollInterval);
                            autoScrollInterval = null;
                        }
                    }
                }
            });
            
            // Âú®Êï¥‰∏™ÊñáÊ°£‰∏äÁõëÂê¨Èº†Ê†áÈáäÊîæÔºåÁ°Æ‰øùÊó†ËÆ∫Âú®Âì™ÈáåÈáäÊîæÈÉΩËÉΩÊ≠£Á°ÆÂÆåÊàêÈÄâÊã©
            document.addEventListener('mouseup', function() {
                // ÂÅúÊ≠¢Ëá™Âä®ÊªöÂä®
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
                
                if (isDragging && startItem) {
                    // Â¶ÇÊûúÊúâendItemÔºåÂÆåÊàêËåÉÂõ¥ÈÄâÊã©
                    if (endItem) {
                        const startIndex = parseInt(startItem.dataset.fileIndex);
                        const endIndex = parseInt(endItem.dataset.fileIndex);
                        const minIndex = Math.min(startIndex, endIndex);
                        const maxIndex = Math.max(startIndex, endIndex);
                        
                        // ‰∏çÊ∏ÖÁ©∫‰πãÂâçÁöÑÈÄâÊã©ÔºåËÄåÊòØÊ∑ªÂä†Âà∞Áé∞ÊúâÈÄâÊã©‰∏≠
                        for (let i = minIndex; i <= maxIndex; i++) {
                            const targetItem = document.querySelector(`[data-file-index="${i}"]`);
                            if (targetItem) {
                                const fileId = targetItem.dataset.fileId;
                                selectedFiles.add(fileId);
                                targetItem.classList.add('selected');
                                targetItem.querySelector('.file-checkbox').checked = true;
                            }
                        }
                        updateBatchActions();
                    }
                    // Â¶ÇÊûúÊ≤°ÊúâendItemÔºàÊØîÂ¶ÇÊªëÂá∫È°µÈù¢ÔºâÔºåËá≥Â∞ë‰øùÁïôÂΩìÂâçÈÄâÊã©ÁöÑÊñá‰ª∂
                }
                
                // Ê∏ÖÁêÜÁä∂ÊÄÅ
                isDragging = false;
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selecting');
                });
                startItem = null;
                endItem = null;
            });
        }
        
        // Êô∫ËÉΩÊñá‰ª∂ÂêçËß£ÊûêÂô®
        function parseFileName(fileName) {
            // ÁßªÈô§Êñá‰ª∂Êâ©Â±ïÂêç
            const nameWithoutExt = fileName.replace(/\.[^.]*$/, '');
            
            let bookName = '';
            let tags = [];
            let author = '';
            
            // 1. ÊèêÂèñ‰π¶Âêç
            // Ê£ÄÊü•ÊòØÂê¶Êúâ„Ää„ÄãÂåÖÂõ¥ÁöÑ‰π¶Âêç
            const bookNameMatch = nameWithoutExt.match(/„Ää([^„Äã]+)„Äã/);
            if (bookNameMatch) {
                bookName = bookNameMatch[1];
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ„Ää„ÄãÔºåÂ∞ùËØïÊèêÂèñÂºÄÂ§¥ÁöÑ‰π¶Âêç
                // ‰π¶ÂêçÈÄöÂ∏∏Âú®ÂºÄÂ§¥ÔºåÂà∞Á¨¨‰∏Ä‰∏™ÁâπÊÆäÂ≠óÁ¨¶‰∏∫Ê≠¢
                const bookNameEnd = nameWithoutExt.search(/[Ôºà\(\[„Äê‰ΩúËÄÖÔºö‰ΩúËÄÖ:‰ΩúËÄÖBY‚Äî_]/);
                if (bookNameEnd > 0) {
                    bookName = nameWithoutExt.substring(0, bookNameEnd);
                } else {
                    bookName = nameWithoutExt;
                }
            }
            
            // 2. ÊèêÂèñÊ†áÁ≠æ
            // ÊèêÂèñÔºàÔºâ‰∏≠ÁöÑÂÜÖÂÆπ
            const tagsMatch = nameWithoutExt.match(/[Ôºà\(]([^Ôºâ\)]+)[Ôºâ\)]/g);
            if (tagsMatch) {
                tagsMatch.forEach(tag => {
                    const tagContent = tag.replace(/[Ôºà\(\)Ôºâ]/g, '');
                    if (tagContent && !tagContent.includes('‰ΩúËÄÖÔºö') && !tagContent.includes('‰ΩúËÄÖ:')) {
                        tags.push(tagContent);
                    }
                });
            }
            
            // ÊèêÂèñ[]‰∏≠ÁöÑÂÜÖÂÆπ
            const bracketTagsMatch = nameWithoutExt.match(/\[([^\]]+)\]/g);
            if (bracketTagsMatch) {
                bracketTagsMatch.forEach(tag => {
                    const tagContent = tag.replace(/[\[\]]/g, '');
                    if (tagContent) {
                        tags.push(tagContent);
                    }
                });
            }
            
            // ÊèêÂèñ„Äê„Äë‰∏≠ÁöÑÂÜÖÂÆπ
            const bracketTagsMatch2 = nameWithoutExt.match(/„Äê([^„Äë]+)„Äë/g);
            if (bracketTagsMatch2) {
                bracketTagsMatch2.forEach(tag => {
                    const tagContent = tag.replace(/„Äê„Äë/g, '');
                    if (tagContent) {
                        tags.push(tagContent);
                    }
                });
            }
            
            // ÊèêÂèñ()‰∏≠ÁöÑÂÜÖÂÆπÔºàËã±ÊñáÊã¨Âè∑Ôºâ
            const englishTagsMatch = nameWithoutExt.match(/\(([^)]+)\)/g);
            if (englishTagsMatch) {
                englishTagsMatch.forEach(tag => {
                    const tagContent = tag.replace(/[()]/g, '');
                    if (tagContent && !tagContent.includes('‰ΩúËÄÖÔºö') && !tagContent.includes('‰ΩúËÄÖ:')) {
                        tags.push(tagContent);
                    }
                });
            }
            
            // 3. ÊèêÂèñ‰ΩúËÄÖ
            // Ê£ÄÊü•"‰ΩúËÄÖÔºö"ÂÖ≥ÈîÆËØç
            const authorMatch = nameWithoutExt.match(/‰ΩúËÄÖÔºö([^Ôºà\(\[„Äê]+)/);
            if (authorMatch) {
                author = authorMatch[1].trim();
            } else {
                // Ê£ÄÊü•"‰ΩúËÄÖ:"ÂÖ≥ÈîÆËØç
                const authorMatch2 = nameWithoutExt.match(/‰ΩúËÄÖ:([^Ôºà\(\[„Äê]+)/);
                if (authorMatch2) {
                    author = authorMatch2[1].trim();
                } else {
                    // Ê£ÄÊü•"‰ΩúËÄÖ"ÂÖ≥ÈîÆËØçÔºà‰∏çÂ∏¶ÂÜíÂè∑Ôºâ
                    const authorMatch3 = nameWithoutExt.match(/‰ΩúËÄÖ([^Ôºà\(\[„Äê]+)/);
                    if (authorMatch3) {
                        author = authorMatch3[1].trim();
                    } else {
                        // Ê£ÄÊü•"BY"ÂÖ≥ÈîÆËØçÔºàÂ∏¶Á©∫Ê†ºÔºâ
                        const byMatch = nameWithoutExt.match(/BY\s+([^Ôºà\(\[„Äê]+)/i);
                        if (byMatch) {
                            author = byMatch[1].trim();
                        } else {
                            // Ê£ÄÊü•"by"ÂÖ≥ÈîÆËØçÔºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºå‰∏çË¶ÅÊ±ÇÁ©∫Ê†ºÔºâ
                            const byMatch2 = nameWithoutExt.match(/by([^Ôºà\(\[„Äê]+)/i);
                            if (byMatch2) {
                                author = byMatch2[1].trim();
                            } else {
                                // Ê£ÄÊü•"_"ÂàÜÈöîÁ¨¶
                                const underscoreMatch = nameWithoutExt.match(/_([^Ôºà\(\[„Äê]+)$/);
                                if (underscoreMatch) {
                                    author = underscoreMatch[1].trim();
                                } else {
                                    // Ê£ÄÊü•"‚Äî"ÂàÜÈöîÁ¨¶
                                    const dashMatch = nameWithoutExt.match(/‚Äî([^Ôºà\(\[„Äê]+)$/);
                                    if (dashMatch) {
                                        author = dashMatch[1].trim();
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Ê∏ÖÁêÜÂíåÊ†ºÂºèÂåñ
            bookName = bookName.trim();
            author = author.trim();
            
            // Ê†áÁ≠æÂéªÈáçÂíåÊ∏ÖÁêÜ
            tags = tags.filter(tag => tag.trim() && !tag.includes('‰ΩúËÄÖÔºö') && !tag.includes('‰ΩúËÄÖ:'));
            tags = [...new Set(tags)]; // ÂéªÈáç
            
            // Á°Æ‰øù‰π¶ÂêçÊúâ„Ää„Äã
            if (bookName && !bookName.startsWith('„Ää') && !bookName.endsWith('„Äã')) {
                if (bookName.startsWith('„Ää') && !bookName.endsWith('„Äã')) {
                    bookName = bookName + '„Äã';
                } else if (!bookName.startsWith('„Ää') && bookName.endsWith('„Äã')) {
                    bookName = '„Ää' + bookName;
                } else {
                    bookName = '„Ää' + bookName + '„Äã';
                }
            }
            
            // Â¶ÇÊûú‰π¶ÂêçÂ§™ÈïøÔºåÂèØËÉΩÊòØËØÜÂà´ÈîôËØØÔºåÂ∞ùËØïÊà™Âèñ
            if (bookName.length > 50) {
                const firstBracket = bookName.indexOf('Ôºà');
                const firstParenthesis = bookName.indexOf('(');
                const firstSquare = bookName.indexOf('[');
                const firstChineseSquare = bookName.indexOf('„Äê');
                
                let cutPoint = Math.min(
                    firstBracket > 0 ? firstBracket : Infinity,
                    firstParenthesis > 0 ? firstParenthesis : Infinity,
                    firstSquare > 0 ? firstSquare : Infinity,
                    firstChineseSquare > 0 ? firstChineseSquare : Infinity
                );
                
                if (cutPoint !== Infinity && cutPoint > 10) {
                    bookName = bookName.substring(0, cutPoint);
                    if (!bookName.endsWith('„Äã')) {
                        bookName = bookName + '„Äã';
                    }
                }
            }
            
            return {
                fileName: fileName, // ÂéüÂßãÊñá‰ª∂Âêç
                bookName: bookName || '„ÄäÊú™Áü•‰π¶Âêç„Äã',
                tags: tags.join(' ') || 'ÊöÇÊó†Ê†áÁ≠æ',
                author: author || 'ÊöÇÊó†‰ΩúËÄÖ'
            };
        }
        
        // ExcelÂØºÂá∫ÂäüËÉΩ
        function exportToExcel() {
            if (!currentDirHandle) {
                alert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂Â§π');
                return;
            }
            
            // ÊòæÁ§∫ÂØºÂá∫ËøõÂ∫¶
            showLoading('Ê≠£Âú®Êî∂ÈõÜÊñá‰ª∂‰ø°ÊÅØ...');
            
            // Êî∂ÈõÜÂΩìÂâçÊñá‰ª∂Â§π‰∏ãÁöÑÊâÄÊúâÊñá‰ª∂‰ø°ÊÅØ
            const files = collectFilesForExport();
            if (files.length === 0) {
                showError('ÂΩìÂâçÊñá‰ª∂Â§πÊ≤°ÊúâÂèØÂØºÂá∫ÁöÑÊñá‰ª∂');
                return;
            }
            
            showLoading(`Ê≠£Âú®Ëß£Êûê ${files.length} ‰∏™Êñá‰ª∂Âêç...`);
            
            // Ëß£ÊûêÊñá‰ª∂ÂêçÂπ∂ÁîüÊàêExcelÊï∞ÊçÆ
            const excelData = files.map((file, index) => {
                if (index % 100 === 0) { // ÊØè100‰∏™Êñá‰ª∂Êõ¥Êñ∞‰∏ÄÊ¨°ËøõÂ∫¶
                    showLoading(`Ê≠£Âú®Ëß£ÊûêÊñá‰ª∂Âêç... (${index + 1}/${files.length})`);
                }
                const parsed = parseFileName(file.name);
                return {
                    'Êñá‰ª∂Âêç': parsed.fileName,
                    '‰π¶Âêç': parsed.bookName,
                    'Ê†áÁ≠æ': parsed.tags,
                    '‰ΩúËÄÖ': parsed.author,
                    'Êñá‰ª∂Ë∑ØÂæÑ': file.path
                };
            });
            
            showLoading('Ê≠£Âú®ÁîüÊàêExcelÊñá‰ª∂...');
            
            // ÂàõÂª∫Â∑•‰ΩúÁ∞ø
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // ËÆæÁΩÆÂàóÂÆΩ
            ws['!cols'] = [
                { width: 40 }, // Êñá‰ª∂ÂêçÂàó
                { width: 30 }, // ‰π¶ÂêçÂàó
                { width: 40 }, // Ê†áÁ≠æÂàó
                { width: 20 }, // ‰ΩúËÄÖÂàó
                { width: 50 }  // Êñá‰ª∂Ë∑ØÂæÑÂàó
            ];
            
            // Ê∑ªÂä†Â∑•‰ΩúË°®Âà∞Â∑•‰ΩúÁ∞ø
            XLSX.utils.book_append_sheet(wb, ws, '‰π¶Á±ç‰ø°ÊÅØ');
            
            // ÁîüÊàêÊñá‰ª∂Âêç - ‰ΩøÁî®ÂΩìÂâçÊñá‰ª∂Â§πÂêçÁß∞
            let currentFolderName = 'Êú™Áü•Êñá‰ª∂Â§π';
            if (navigationHistory.length > 0) {
                const currentNode = navigationHistory[currentHistoryIndex];
                if (currentNode) {
                    currentFolderName = currentNode.name;
                }
            }
            const timestamp = new Date().toISOString().slice(0, 10); // Âè™ÂèñÊó•ÊúüÈÉ®ÂàÜ YYYY-MM-DD
            const fileName = `${currentFolderName}_‰π¶Á±ç‰ø°ÊÅØ_${timestamp}.xlsx`;
            
            showLoading('Ê≠£Âú®‰∏ãËΩΩÊñá‰ª∂...');
            
            // ‰∏ãËΩΩÊñá‰ª∂
            XLSX.writeFile(wb, fileName);
            
            // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
            showSuccess(`ÊàêÂäüÂØºÂá∫ ${files.length} ‰∏™Êñá‰ª∂Âà∞ExcelÔºÅÊñá‰ª∂ÂêçÔºö${fileName}`);
        }
        
        // Êî∂ÈõÜÂΩìÂâçÊñá‰ª∂Â§π‰∏ãÁöÑÊñá‰ª∂‰ø°ÊÅØ
        function collectFilesForExport() {
            const files = [];
            
            // ÈÄíÂΩíÊî∂ÈõÜÊâÄÊúâÊñá‰ª∂
            function collectFiles(node) {
                if (node.type === 'file') {
                    files.push({
                        name: node.name,
                        path: getItemPath(node)
                    });
                } else if (node.children) {
                    node.children.forEach(child => collectFiles(child));
                }
            }
            
            // ‰ªéÂΩìÂâçÊñá‰ª∂Â§πÂºÄÂßãÊî∂ÈõÜ
            if (navigationHistory.length > 0) {
                const currentNode = navigationHistory[currentHistoryIndex];
                if (currentNode) {
                    collectFiles(currentNode);
                }
            }
            
            return files;
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàê
        window.onload = function() {
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
            if (!('showDirectoryPicker' in window)) {
                showError('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊñá‰ª∂Á≥ªÁªüËÆøÈóÆAPIÔºåËØ∑‰ΩøÁî®Chrome„ÄÅEdgeÊàñFirefoxÊúÄÊñ∞ÁâàÊú¨');
            }
        };
        
        // ÊòæÁ§∫/ÈöêËóèÂ∏ÆÂä©ÂØπËØùÊ°Ü
        function toggleHelp() {
            const helpDialog = document.getElementById('helpDialog');
            if (helpDialog.classList.contains('show')) {
                helpDialog.classList.remove('show');
            } else {
                helpDialog.classList.add('show');
            }
        }
        
        // ÁÇπÂáªÂ∏ÆÂä©ÂØπËØùÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        document.addEventListener('click', function(e) {
            const helpDialog = document.getElementById('helpDialog');
            const helpContent = document.querySelector('.help-content');
            if (e.target === helpDialog) {
                helpDialog.classList.remove('show');
            }
        });
        
        // ÊòæÁ§∫Áà±ÂøÉÂä®Áîª+
        function showHeart() {
            // ÂàõÂª∫Áà±ÂøÉÂÖÉÁ¥†
            const heart = document.createElement('div');
            heart.className = 'heart';
            heart.innerHTML = '‚ù§Ô∏è';
            
            // ËÆæÁΩÆÁà±ÂøÉ‰ΩçÁΩÆÔºàÂú®ËÅîÁ≥ªÊñπÂºè‰∏äÊñπÈöèÊú∫‰ΩçÁΩÆÔºâ
            const supportInfo = document.querySelector('.support-info');
            const rect = supportInfo.getBoundingClientRect();
            
            // Âú®ÊåâÈíÆ‰∏äÊñπÈöèÊú∫‰ΩçÁΩÆÂá∫Áé∞
            const randomOffsetX = (Math.random() - 0.5) * rect.width; // Âú®ÊåâÈíÆÂÆΩÂ∫¶ËåÉÂõ¥ÂÜÖÈöèÊú∫
            const startX = rect.left + rect.width / 2 + randomOffsetX;
            const startY = rect.top - 20; // Âú®ÊåâÈíÆ‰∏äÊñπ20pxÂ§ÑÂºÄÂßã
            
            heart.style.left = startX + 'px';
            heart.style.top = startY + 'px';
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(heart);
            
            // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§ÂÖÉÁ¥†Ôºà3ÁßíÂêéÔºâ
            setTimeout(() => {
                if (heart.parentNode) {
                    heart.parentNode.removeChild(heart);
                }
            }, 3000);
        }
    </script>
</body>
</html> 